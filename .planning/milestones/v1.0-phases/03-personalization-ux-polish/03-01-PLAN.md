---
phase: 03-personalization-ux-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/storage/types.ts
  - src/storage/useStorage.ts
autonomous: true
requirements: [PERS-01, PERS-04]

must_haves:
  truths:
    - "UserSettings interface exists with tone, depth, profession, displayMode, keyboardShortcut, dismissedOnboardingPrompts fields"
    - "DEFAULT_SETTINGS exports sensible defaults: tone 12, depth medium, displayMode replace, keyboardShortcut Ctrl+Shift+1"
    - "useStorageSyncValue hook reads and writes chrome.storage.sync (not local)"
    - "Extension works on first install with no configuration — defaults apply automatically"
  artifacts:
    - path: "src/storage/types.ts"
      provides: "UserSettings interface and DEFAULT_SETTINGS constant"
      contains: "UserSettings"
    - path: "src/storage/useStorage.ts"
      provides: "useStorageSyncValue hook for settings persisted across sessions"
      exports: ["useStorageSyncValue"]
  key_links:
    - from: "src/storage/useStorage.ts"
      to: "chrome.storage.sync"
      via: "useStorageSyncValue hook"
      pattern: "chrome\\.storage\\.sync\\.(get|set)"
---

<objective>
Establish the settings storage foundation that all Phase 3 personalization features depend on.

Purpose: Every Phase 3 feature reads/writes user preferences (tone, depth, profession, display mode, keyboard shortcut). These must be persisted via chrome.storage.sync so they survive browser restarts and sync across profiles. The existing useStorageValue hook only handles chrome.storage.local — a parallel hook for sync storage is needed.

Output: Extended types.ts with UserSettings + DEFAULT_SETTINGS; extended useStorage.ts with useStorageSyncValue hook.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/storage/types.ts
@src/storage/useStorage.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add UserSettings interface and DEFAULT_SETTINGS to storage types</name>
  <files>src/storage/types.ts</files>
  <action>
Append to `src/storage/types.ts` — do NOT remove or modify ExtensionState or DEFAULT_STATE (existing code uses them).

Add the following after the existing DEFAULT_STATE export:

1. `ToneLevel` union type: `'baby' | 5 | 12 | 18 | 'big_boy'` — these are the five age levels; baby = playful mode, 12 = on-brand default, big_boy = adult complexity.

2. `UserSettings` interface with fields:
   - `tone: ToneLevel` — age-based simplification level
   - `depth: 'light' | 'medium' | 'detailed'` — explanation detail level (separate from tone)
   - `profession: string` — free text ("I'm a nurse", "I do marketing") for relatable analogies
   - `displayMode: 'replace' | 'popup'` — where simplified text appears
   - `keyboardShortcut: string` — e.g., 'Ctrl+Shift+1' (stored for display only; chrome.commands controls actual binding)
   - `dismissedOnboardingPrompts: string[]` — IDs of dismissed onboarding prompts ('tone', 'depth', 'profession')

3. `DEFAULT_SETTINGS: UserSettings` constant with:
   - `tone: 12` — "Twelveify" brand default
   - `depth: 'medium'`
   - `profession: ''`
   - `displayMode: 'replace'`
   - `keyboardShortcut: 'Ctrl+Shift+1'`
   - `dismissedOnboardingPrompts: []`

Add JSDoc comments explaining each field and its storage location (sync).
  </action>
  <verify>
Run `npx tsc --noEmit` from project root — should compile with no errors. Check that `ToneLevel`, `UserSettings`, `DEFAULT_SETTINGS` are exported.
  </verify>
  <done>types.ts compiles cleanly; UserSettings and DEFAULT_SETTINGS are exported; existing ExtensionState and DEFAULT_STATE are unchanged.</done>
</task>

<task type="auto">
  <name>Task 2: Add useStorageSyncValue hook to useStorage.ts</name>
  <files>src/storage/useStorage.ts</files>
  <action>
Append `useStorageSyncValue` to `src/storage/useStorage.ts` — do NOT modify the existing `useStorageValue` function (local storage hook used by FloatingButton, background.ts).

The new `useStorageSyncValue<T>(key: string, defaultValue: T): [T, (value: T) => Promise<void>]` hook must:

1. Use `chrome.storage.sync.get([key])` to read the initial value on mount.
2. Use `chrome.storage.onChanged.addListener` to react to changes — but ONLY when the storage area is 'sync' (listener receives `(changes, areaName)` — check `areaName === 'sync'`).
3. Return `[value, setter]` exactly like `useStorageValue`.
4. Setter calls `chrome.storage.sync.set({ [key]: newValue })` and updates local React state.

Important: The chrome.storage.onChanged event fires for BOTH local and sync areas. The listener MUST check `areaName === 'sync'` before updating state, otherwise changes to chrome.storage.local will incorrectly trigger sync hook re-renders.

Also: Initialize the sync storage with DEFAULT_SETTINGS on first install. Do this by exporting an `initSyncDefaults` helper:

```typescript
export async function initSyncDefaults(defaults: Record<string, unknown>): Promise<void> {
  const existing = await new Promise<Record<string, unknown>>((resolve) =>
    chrome.storage.sync.get(null, (result) => resolve(result))
  );
  const toSet: Record<string, unknown> = {};
  for (const [key, value] of Object.entries(defaults)) {
    if (existing[key] === undefined) {
      toSet[key] = value;
    }
  }
  if (Object.keys(toSet).length > 0) {
    await new Promise<void>((resolve) => chrome.storage.sync.set(toSet, resolve));
  }
}
```

Add JSDoc explaining the sync-vs-local distinction and the areaName check.
  </action>
  <verify>
Run `npx tsc --noEmit` — no errors. Confirm `useStorageSyncValue` and `initSyncDefaults` are exported from the file. Grep for `chrome.storage.sync` in useStorage.ts to verify sync API is used.
  </verify>
  <done>useStorage.ts compiles cleanly; useStorageSyncValue reads from chrome.storage.sync and listens only to sync area changes; initSyncDefaults exported; existing useStorageValue unchanged.</done>
</task>

</tasks>

<verification>
Run `npx tsc --noEmit` from `/Users/brunocampos/Twelvify` — must pass with zero errors.
Grep for `useStorageSyncValue` in `src/storage/useStorage.ts` — must exist.
Grep for `UserSettings` in `src/storage/types.ts` — must exist.
Grep for `DEFAULT_SETTINGS` in `src/storage/types.ts` — must exist with `tone: 12`.
</verification>

<success_criteria>
- types.ts exports ToneLevel, UserSettings, DEFAULT_SETTINGS with tone: 12 default
- useStorage.ts exports useStorageSyncValue (sync storage hook) and initSyncDefaults
- Existing ExtensionState, DEFAULT_STATE, useStorageValue unchanged
- TypeScript compiles cleanly (npx tsc --noEmit)
</success_criteria>

<output>
After completion, create `.planning/phases/03-personalization-ux-polish/03-01-SUMMARY.md` following the summary template.
</output>
