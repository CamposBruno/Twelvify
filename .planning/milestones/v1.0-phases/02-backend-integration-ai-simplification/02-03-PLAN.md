---
phase: 02-backend-integration-ai-simplification
plan: "03"
type: execute
wave: 3
depends_on:
  - "02-02"
files_modified:
  - src/components/FloatingButton.tsx
  - src/components/ErrorTooltip.tsx
autonomous: true
requirements:
  - ERRH-01
  - ERRH-02
  - ERRH-03
  - ERRH-04

must_haves:
  truths:
    - "When offline, button turns warning yellow, shakes once, and a sarcastic tooltip appears: 'Wow, no internet. Shocking.'"
    - "When rate limit hit, tooltip shows exact reset time: 'Chill, I need a break. Try again in N minutes.'"
    - "When timeout, tooltip shows: 'That took too long. Hit me again?' and user can click Simplify again"
    - "When text too long, tooltip shows: 'Easy there, speed racer. That\'s too much to chew. Select a shorter passage (under 5000 characters).'"
    - "Tooltip auto-dismisses after 5 seconds; user can also click anywhere to dismiss sooner"
    - "After error is shown and dismissed, button returns to its normal indigo color and ready state"
  artifacts:
    - path: "src/components/ErrorTooltip.tsx"
      provides: "Error tooltip bubble component anchored to FloatingButton position"
      min_lines: 40
    - path: "src/components/FloatingButton.tsx"
      provides: "Yellow button state + CSS shake animation + ErrorTooltip integration"
      contains: "twelvify-shake"
  key_links:
    - from: "src/components/FloatingButton.tsx"
      to: "src/components/ErrorTooltip.tsx"
      via: "renders ErrorTooltip when errorState is non-null"
      pattern: "ErrorTooltip"
    - from: "src/components/FloatingButton.tsx"
      to: "chrome.storage errorState"
      via: "useStorageValue('errorState') — auto-dismisses after 5s via setTimeout"
      pattern: "errorState"
---

<objective>
Build the error presentation layer: yellow button with shake animation, sarcastic tooltip bubbles anchored to the floating button, and auto-dismiss after 5 seconds. Implements all four ERRH requirements visually.

Purpose: Per CONTEXT.md locked decisions — errors must feel tactile and physical (yellow + shiver/shake), have sarcastic personality (not bland "an error occurred"), show specific information (rate limit reset time), and auto-dismiss after 5 seconds. This plan implements those requirements in full.

Output: ErrorTooltip.tsx component + FloatingButton.tsx extended with yellow error state, CSS shake keyframe, and tooltip rendering. All four error scenarios covered.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-backend-integration-ai-simplification/02-CONTEXT.md
@.planning/phases/02-backend-integration-ai-simplification/02-02-SUMMARY.md
@src/components/FloatingButton.tsx
@src/storage/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ErrorTooltip component</name>
  <files>
    src/components/ErrorTooltip.tsx
  </files>
  <action>
    Create `src/components/ErrorTooltip.tsx` — a tooltip bubble that appears above/beside the FloatingButton when errorState is non-null.

    ```typescript
    // src/components/ErrorTooltip.tsx
    // Sarcastic error tooltip anchored to the floating button
    // Appears above the button, auto-dismisses after 5 seconds

    import React from 'react';

    interface ErrorTooltipProps {
      message: string;
      onDismiss: () => void;
    }

    export function ErrorTooltip({ message, onDismiss }: ErrorTooltipProps) {
      return (
        <div
          onClick={onDismiss}
          role="alert"
          aria-live="assertive"
          style={{
            position: 'absolute',
            bottom: 'calc(100% + 8px)',  // 8px above the button
            right: '0',
            backgroundColor: '#1f2937',  // Dark background
            color: '#f9fafb',
            borderRadius: '8px',
            padding: '10px 14px',
            fontSize: '13px',
            fontFamily: 'system-ui, -apple-system, sans-serif',
            lineHeight: '1.4',
            maxWidth: '240px',
            minWidth: '160px',
            boxShadow: '0 4px 16px rgba(0, 0, 0, 0.25)',
            cursor: 'pointer',
            userSelect: 'none',
            whiteSpace: 'pre-wrap',
            // Arrow pointing down at the button
            // Using a pseudo-element would need CSS; use a small triangle div instead
          }}
        >
          {message}
          {/* Arrow pointing down toward the button */}
          <div
            style={{
              position: 'absolute',
              bottom: '-6px',
              right: '18px',
              width: '0',
              height: '0',
              borderLeft: '6px solid transparent',
              borderRight: '6px solid transparent',
              borderTop: '6px solid #1f2937',
            }}
          />
        </div>
      );
    }
    ```

    The tooltip is dismissible on click (calls onDismiss). The auto-dismiss (5s timeout) is managed by FloatingButton in Task 2. The tooltip is positioned absolutely relative to the FloatingButton container (which is already `position: fixed`).
  </action>
  <verify>
    npm run build → exits 0 (new file imports cleanly)
  </verify>
  <done>
    src/components/ErrorTooltip.tsx exists, exports ErrorTooltip, accepts message and onDismiss props. npm run build passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Extend FloatingButton with yellow error state, shake animation, and ErrorTooltip integration</name>
  <files>
    src/components/FloatingButton.tsx
  </files>
  <action>
    Extend the existing FloatingButton.tsx to:

    1. **Add CSS keyframe for shake animation** — append to the existing `<style>` tag:
    ```css
    @keyframes twelvify-shake {
      0%, 100% { transform: translateX(0); }
      15% { transform: translateX(-5px) rotate(-1deg); }
      30% { transform: translateX(5px) rotate(1deg); }
      45% { transform: translateX(-4px); }
      60% { transform: translateX(4px); }
      75% { transform: translateX(-2px); }
      90% { transform: translateX(2px); }
    }
    ```

    2. **Read errorState from storage** — already added in Plan 02, now use it:
    ```typescript
    const [errorState, setErrorState] = useStorageValue<ExtensionState['errorState']>('errorState', null);
    ```

    3. **Auto-dismiss timer** — when errorState becomes non-null, start a 5-second auto-dismiss:
    ```typescript
    const dismissTimerRef = React.useRef<ReturnType<typeof setTimeout> | null>(null);

    React.useEffect(() => {
      if (errorState) {
        // Clear any existing timer
        if (dismissTimerRef.current) clearTimeout(dismissTimerRef.current);
        dismissTimerRef.current = setTimeout(() => {
          setErrorState(null);  // Clears errorState in chrome.storage via useStorageValue setter
        }, 5000);
      }
      return () => {
        if (dismissTimerRef.current) clearTimeout(dismissTimerRef.current);
      };
    }, [errorState]);
    ```

    4. **Shake animation trigger** — use a local React state `isShaking` that becomes true when errorState first appears:
    ```typescript
    const [isShaking, setIsShaking] = React.useState(false);
    const prevErrorRef = React.useRef<typeof errorState>(null);

    React.useEffect(() => {
      if (errorState && !prevErrorRef.current) {
        // New error — trigger shake
        setIsShaking(true);
        setTimeout(() => setIsShaking(false), 600);  // Match shake animation duration
      }
      prevErrorRef.current = errorState;
    }, [errorState]);
    ```

    5. **Button style when error** — change backgroundColor to warning yellow (#f59e0b) when errorState is non-null and not loading:
    ```typescript
    const buttonBg = isLoading
      ? '#6366f1'           // Indigo during loading
      : errorState
        ? '#f59e0b'         // Warning yellow on error
        : '#6366f1';        // Default indigo
    ```

    6. **Apply shake animation style on button**:
    ```typescript
    animation: isShaking ? 'twelvify-shake 0.6s ease' : undefined,
    ```

    7. **Render ErrorTooltip** — inside the outer container div, ABOVE the button, when errorState is non-null:
    ```typescript
    {errorState && (
      <ErrorTooltip
        message={errorState.message}
        onDismiss={() => setErrorState(null)}
      />
    )}
    ```

    The container div already has `position: fixed`; ErrorTooltip uses `position: absolute` relative to this container. The container needs `overflow: visible` (it should already have it since it has no overflow set).

    8. **Import ErrorTooltip and React.useRef, React.useEffect** — ensure all necessary imports are present. The file already imports React from 'react'.

    Final FloatingButton structure after changes:
    ```
    <div id="twelvify-floating-btn" style={containerStyle}>
      {errorState && <ErrorTooltip message={...} onDismiss={...} />}
      <button style={{ backgroundColor: buttonBg, animation: shake, ... }}>
        {spinner or icon}
      </button>
      <style>{keyframes}</style>
    </div>
    ```

    Verify: npm run build exits 0. Inspect FloatingButton.tsx manually to confirm all 8 changes applied correctly.
  </action>
  <verify>
    1. npm run build → exits 0
    2. grep "twelvify-shake" src/components/FloatingButton.tsx → present (keyframe defined)
    3. grep "f59e0b" src/components/FloatingButton.tsx → present (yellow error color)
    4. grep "ErrorTooltip" src/components/FloatingButton.tsx → present (tooltip rendered)
    5. grep "dismissTimerRef\|5000" src/components/FloatingButton.tsx → present (auto-dismiss)
    6. grep "isShaking" src/components/FloatingButton.tsx → present (shake state)
  </verify>
  <done>
    FloatingButton.tsx renders ErrorTooltip when errorState is non-null. Button turns warning yellow (#f59e0b) on error. twelvify-shake CSS keyframe triggers once when error appears. Auto-dismiss fires after 5 seconds via setTimeout. User can click tooltip to dismiss immediately. After dismissal, button returns to indigo and tooltip disappears. npm run build passes.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. npm run build → exits 0
2. grep "twelvify-shake" src/components/FloatingButton.tsx → keyframe present
3. grep "f59e0b" src/components/FloatingButton.tsx → yellow error color present
4. grep "ErrorTooltip" src/components/FloatingButton.tsx → tooltip import and render present
5. grep "5000" src/components/FloatingButton.tsx → 5-second auto-dismiss present
6. cat src/components/ErrorTooltip.tsx → exports ErrorTooltip with message + onDismiss props
7. Confirm all 4 error messages trace to content.ts:
   - grep "no internet" src/entrypoints/content.ts → ERRH-01
   - grep "need a break\|minutes" src/entrypoints/content.ts → ERRH-02
   - grep "too long\|Hit me again" src/entrypoints/content.ts → ERRH-03
   - grep "speed racer\|5000" src/entrypoints/content.ts → ERRH-04
</verification>

<success_criteria>
- ErrorTooltip component exists and renders above the FloatingButton when errorState is set (ERRH-01, ERRH-02, ERRH-03, ERRH-04)
- Button turns yellow (#f59e0b) on any error (per CONTEXT.md locked decision)
- Shake animation (twelvify-shake keyframe) plays once on error appearance (per CONTEXT.md locked decision)
- Auto-dismiss after 5 seconds; manual dismiss on click (per CONTEXT.md locked decision)
- All four sarcastic error messages present in content.ts (appropriate per CONTEXT.md tone)
- npm run build passes cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/02-backend-integration-ai-simplification/02-03-SUMMARY.md`
</output>
