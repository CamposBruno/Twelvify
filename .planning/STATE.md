# Session State

## Project Reference

See: .planning/PROJECT.md

## Position

**Milestone:** v1.0 milestone
**Current phase:** 03-personalization-ux-polish
**Current Plan:** 03-04 (next)
**Status:** In progress

## Decisions

- Used srcDir: 'src' in wxt.config.ts so WXT resolves entrypoints at src/entrypoints/ (WXT default is root/entrypoints)
- npm create wxt@latest unavailable — scaffolded project manually with identical structure to react-ts template
- Manifest config co-located in wxt.config.ts (no separate public/manifest.json needed — WXT merges at build time)
- Only 'storage' permission granted — principle of least privilege per EXTF-04
- [Phase 01-foundation-text-selection]: Used srcDir: src in wxt.config.ts so WXT resolves entrypoints at src/entrypoints
- [Phase 01-02]: Listeners at defineBackground() top level — MV3 service workers terminate/restart, async-registered listeners may not fire
- [Phase 01-02]: All state in chrome.storage.local — module-scope variables lost when service worker idles 30s
- [Phase 01-02]: useStorageValue hook uses onChanged listener for real-time popup sync
- [Phase 01-03]: Popover API (popover="manual") renders in browser top layer — zero z-index management needed
- [Phase 01-03]: Both selectionchange and mouseup events needed for keyboard and mouse drag selection coverage
- [Phase 01-03]: react-dom/client (not react/client) is the correct React 18 createRoot import path
- [Phase 01-04]: Always-render pattern — FloatingButton never returns null; CSS opacity/pointerEvents toggle eliminates showPopover race condition
- [Phase 01-04]: Storage-driven visibility — FloatingButton reads selectedText via useStorageValue; content script only dispatches messages
- [Phase 01-04]: z-index 2147483647 used instead of Popover API top-layer for button stacking
- [Phase 03-personalization-ux-polish]: getButtonLabel returns ONE-LEVEL-LOWER label — button invites simplification to next level down
- [Phase 03-personalization-ux-polish]: UndoStack holds direct Text node reference — avoids Range serialization, valid for full page lifetime

## Session Log

- 2026-02-23: STATE.md regenerated by /gsd:health --repair
- 2026-02-23: Completed 01-01 (WXT scaffold + Manifest V3 config). Tasks: 2, commits: e834ad0, 4dc9b5f
- 2026-02-23: Completed 01-02 (Service worker + chrome.storage state management). Tasks: 2, commits: 108e26b, 689493b
- 2026-02-23: Completed 01-03 (Content script + FloatingButton with Popover API). Tasks: 2, commits: f5665cd, b156473
- 2026-02-23: Completed 01-04 (Gap closure — FloatingButton race condition fix + React import). Tasks: 3, commits: 39d037e, de3f6d1, aaefa2f. Human-verified: all UAT tests pass.
- 2026-02-24: Completed 02-01 (Express backend proxy — SSE streaming, rate limiting, privacy logging). Tasks: 2, commits: b3ce09b, 680abf4. Requires real OPENAI_API_KEY in backend/.env.local for end-to-end testing.
- 2026-02-24: Completed 02-02 (Backend integration — SSE streaming simplification wired end-to-end, DOM in-place replacement, client-side rate limit). Tasks: 2, commits: 6e60aeb, 7decb91.
- 2026-02-23: Completed 02-03 (Error presentation layer — ErrorTooltip component, yellow button state, shake animation, auto-dismiss). Tasks: 2, commits: fc35a1a, 710e5f4.
- [Phase 01-04]: Explicit React import needed in content script .tsx — Vite auto JSX transform fails on async re-renders
- [Phase 02-01]: gpt-4o-mini selected for cost efficiency; upgrade path to gpt-4-turbo documented in aiClient.ts
- [Phase 02-01]: express-rate-limit v7 uses AugmentedRequest type — cast required in handler to access req.rateLimit
- [Phase 02-01]: SHA-256(IP:UserAgent).slice(0,16) fingerprint for anonymous rate limiting without user accounts
- [Phase 02-01]: Trust proxy enabled (app.set('trust proxy', 1)) for correct IP behind Vercel/Render/nginx
- [Phase 02-02]: fetch+ReadableStream used for SSE instead of EventSource — EventSource doesn't support POST with body
- [Phase 02-02]: DOM Range captured before async fetch to preserve selection if user clicks away during streaming
- [Phase 02-02]: Client-side rate limit window (50 req/hr) tracked in chrome.storage via simplifyCountThisHour/hourWindowStart
- [Phase 02-02]: wxt.config.ts host_permissions updated to twelvify-backend.onrender.com — must update before Web Store submission
- [Phase 02-03]: ErrorTooltip positioned absolute relative to fixed FloatingButton container — no portal needed, no z-index management
- [Phase 02-03]: isShaking state separate from errorState lifetime — prevErrorRef detects null-to-error transitions, shake fires once only
- [Phase 02-03]: useStorageValue setter used for dismiss — keeps dismissal path consistent with storage-driven visibility pattern
- 2026-02-23: Completed 02-04 (Human UAT — Phase 2 end-to-end verification). Tasks: 1 checkpoint, commits: 9b62e6c (fix). Human-verified: streaming works, all 4 error scenarios pass, no user text in logs, quality acceptable. Phase 02 complete.
- [Phase 02-04]: CORS ALLOWED_ORIGIN must be * for content scripts — content scripts send page origin (not extension origin), static extension-origin allowlist cannot work
- [Phase 02-04]: Backend URL uses localhost:3001 for local dev — must update content.ts URL and host_permissions in wxt.config.ts before Render deployment / Web Store submission
- 2026-02-24: Completed 03-01 (Settings storage foundation — UserSettings, ToneLevel, DEFAULT_SETTINGS, useStorageSyncValue, initSyncDefaults). Tasks: 2, commits: acbf780, 2f02816.
- 2026-02-24: Completed 03-03 (Keyboard shortcut plumbing — simplify-hotkey in manifest, SIMPLIFY_HOTKEY message type, chrome.commands.onCommand handler in background.ts). Tasks: 2, commits: 103f81b, 739bbd5.
- [Phase 03-01]: ToneLevel uses literal numbers (5, 12, 18) and string literals (baby, big_boy) — union type prevents invalid tone values
- [Phase 03-01]: chrome.storage.sync chosen for UserSettings — syncs across profiles and survives browser restarts
- [Phase 03-01]: onChanged listener guards areaName === 'sync' to prevent local storage changes from triggering sync hook re-renders
- [Phase 03-01]: initSyncDefaults only writes absent keys — safe to call on every install/update without clobbering prefs
- [Phase 03-01]: keyboardShortcut stored in sync for display only — actual binding managed by chrome.commands in manifest
- [Phase 03-02]: (completed previously)
- [Phase 03-03]: suggested_key uses object form { default/mac } per Chrome commands API spec (not flat string)
- [Phase 03-03]: chrome.commands.onCommand registered at top level of defineBackground() for MV3 service worker restart safety
- [Phase 03-03]: SIMPLIFY_HOTKEY switch case added to handleMessage to prevent Unknown message type errors if routed back
- [Phase 03-03]: Silent lastError suppression in sendMessage callback handles chrome:// pages where content scripts cannot inject
