# Session State

## Project Reference

See: .planning/PROJECT.md

## Position

**Milestone:** v1.0 milestone
**Current phase:** 02-backend-integration-ai-simplification
**Current Plan:** 02-02 complete (02-03 next)
**Status:** In progress

## Decisions

- Used srcDir: 'src' in wxt.config.ts so WXT resolves entrypoints at src/entrypoints/ (WXT default is root/entrypoints)
- npm create wxt@latest unavailable — scaffolded project manually with identical structure to react-ts template
- Manifest config co-located in wxt.config.ts (no separate public/manifest.json needed — WXT merges at build time)
- Only 'storage' permission granted — principle of least privilege per EXTF-04
- [Phase 01-foundation-text-selection]: Used srcDir: src in wxt.config.ts so WXT resolves entrypoints at src/entrypoints
- [Phase 01-02]: Listeners at defineBackground() top level — MV3 service workers terminate/restart, async-registered listeners may not fire
- [Phase 01-02]: All state in chrome.storage.local — module-scope variables lost when service worker idles 30s
- [Phase 01-02]: useStorageValue hook uses onChanged listener for real-time popup sync
- [Phase 01-03]: Popover API (popover="manual") renders in browser top layer — zero z-index management needed
- [Phase 01-03]: Both selectionchange and mouseup events needed for keyboard and mouse drag selection coverage
- [Phase 01-03]: react-dom/client (not react/client) is the correct React 18 createRoot import path
- [Phase 01-04]: Always-render pattern — FloatingButton never returns null; CSS opacity/pointerEvents toggle eliminates showPopover race condition
- [Phase 01-04]: Storage-driven visibility — FloatingButton reads selectedText via useStorageValue; content script only dispatches messages
- [Phase 01-04]: z-index 2147483647 used instead of Popover API top-layer for button stacking

## Session Log

- 2026-02-23: STATE.md regenerated by /gsd:health --repair
- 2026-02-23: Completed 01-01 (WXT scaffold + Manifest V3 config). Tasks: 2, commits: e834ad0, 4dc9b5f
- 2026-02-23: Completed 01-02 (Service worker + chrome.storage state management). Tasks: 2, commits: 108e26b, 689493b
- 2026-02-23: Completed 01-03 (Content script + FloatingButton with Popover API). Tasks: 2, commits: f5665cd, b156473
- 2026-02-23: Completed 01-04 (Gap closure — FloatingButton race condition fix + React import). Tasks: 3, commits: 39d037e, de3f6d1, aaefa2f. Human-verified: all UAT tests pass.
- 2026-02-24: Completed 02-01 (Express backend proxy — SSE streaming, rate limiting, privacy logging). Tasks: 2, commits: b3ce09b, 680abf4. Requires real OPENAI_API_KEY in backend/.env.local for end-to-end testing.
- 2026-02-24: Completed 02-02 (Backend integration — SSE streaming simplification wired end-to-end, DOM in-place replacement, client-side rate limit). Tasks: 2, commits: 6e60aeb, 7decb91.
- [Phase 01-04]: Explicit React import needed in content script .tsx — Vite auto JSX transform fails on async re-renders
- [Phase 02-01]: gpt-4o-mini selected for cost efficiency; upgrade path to gpt-4-turbo documented in aiClient.ts
- [Phase 02-01]: express-rate-limit v7 uses AugmentedRequest type — cast required in handler to access req.rateLimit
- [Phase 02-01]: SHA-256(IP:UserAgent).slice(0,16) fingerprint for anonymous rate limiting without user accounts
- [Phase 02-01]: Trust proxy enabled (app.set('trust proxy', 1)) for correct IP behind Vercel/Render/nginx
- [Phase 02-02]: fetch+ReadableStream used for SSE instead of EventSource — EventSource doesn't support POST with body
- [Phase 02-02]: DOM Range captured before async fetch to preserve selection if user clicks away during streaming
- [Phase 02-02]: Client-side rate limit window (50 req/hr) tracked in chrome.storage via simplifyCountThisHour/hourWindowStart
- [Phase 02-02]: wxt.config.ts host_permissions updated to twelvify-backend.onrender.com — must update before Web Store submission
