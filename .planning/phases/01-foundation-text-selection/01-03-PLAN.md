---
phase: 01-foundation-text-selection
plan: 03
type: execute
wave: 2
depends_on:
  - "01-01"
files_modified:
  - src/entrypoints/content.ts
  - src/components/FloatingButton.tsx
autonomous: true
requirements:
  - EXTF-03
  - SIMP-01
  - DISP-03

must_haves:
  truths:
    - "User highlights text on a webpage and a floating Simplify button appears within 200ms"
    - "Floating button uses Popover API — zero custom z-index in CSS"
    - "Button appears correctly on diverse page structures (news, blog, Twitter, GitHub, forums)"
    - "Deselecting text hides the floating button"
    - "Content script handles textarea/input selection (via selectionStart/End, not getSelection)"
    - "FloatingButton shows a loading spinner when isLoading is true in chrome.storage"
  artifacts:
    - path: "src/entrypoints/content.ts"
      provides: "Content script with text selection detection and message passing"
      contains: "selectionchange"
    - path: "src/components/FloatingButton.tsx"
      provides: "Popover API-based floating button injected into page DOM"
      contains: "popover"
  key_links:
    - from: "src/entrypoints/content.ts"
      to: "src/entrypoints/background.ts"
      via: "chrome.runtime.sendMessage TEXT_SELECTED"
      pattern: "chrome\\.runtime\\.sendMessage"
    - from: "src/entrypoints/content.ts"
      to: "src/components/FloatingButton.tsx"
      via: "React createRoot injection into document.body"
      pattern: "createRoot"
    - from: "src/components/FloatingButton.tsx"
      to: "chrome.storage.local"
      via: "useStorageValue hook listening to isLoading"
      pattern: "useStorageValue.*isLoading"
---

<objective>
Implement the content script that detects text selection across diverse page structures and injects a floating Simplify button using the Popover API. Add the loading indicator state to the button for Phase 2 readiness.

Purpose: This is the user-facing entry point for the core value proposition — "select text, see button." The Popover API eliminates z-index wars entirely. The loading state infrastructure prepares for Phase 2 AI integration.
Output: Content script with selection detection + FloatingButton component with Popover API rendering + loading indicator support.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-text-selection/01-RESEARCH.md
@.planning/phases/01-foundation-text-selection/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create FloatingButton component with Popover API</name>
  <files>
    src/components/FloatingButton.tsx
  </files>
  <action>
    Create src/components/FloatingButton.tsx as the Popover API-based floating button injected into page DOM:

    ```tsx
    // src/components/FloatingButton.tsx
    // Floating simplify button using native Popover API
    // Popover API renders in top layer — zero z-index management needed
    // Chrome 114+ (cross-browser Baseline stable as of April 2025)

    import { useStorageValue } from '../storage/useStorage';

    interface FloatingButtonProps {
      onSimplify: () => void;
    }

    export function FloatingButton({ onSimplify }: FloatingButtonProps) {
      const [isLoading] = useStorageValue<boolean>('isLoading', false);
      const [selectedText] = useStorageValue<string>('selectedText', '');

      if (!selectedText) {
        return null;
      }

      return (
        // Popover renders in the top layer above all page content
        // No z-index needed — Popover API handles layering natively
        <div
          id="twelvify-floating-btn"
          popover="manual"
          style={{
            position: 'fixed',
            bottom: '24px',
            right: '24px',
            border: 'none',
            padding: '0',
            background: 'transparent',
            margin: '0',
          }}
        >
          <button
            onClick={isLoading ? undefined : onSimplify}
            disabled={isLoading}
            aria-label={isLoading ? 'Simplifying...' : 'Simplify selected text'}
            style={{
              display: 'flex',
              alignItems: 'center',
              gap: '8px',
              padding: '10px 16px',
              backgroundColor: '#6366f1',
              color: '#ffffff',
              border: 'none',
              borderRadius: '8px',
              fontSize: '14px',
              fontWeight: '600',
              cursor: isLoading ? 'not-allowed' : 'pointer',
              boxShadow: '0 4px 12px rgba(0, 0, 0, 0.15)',
              fontFamily: 'system-ui, -apple-system, sans-serif',
              opacity: isLoading ? 0.8 : 1,
            }}
          >
            {isLoading ? (
              <>
                {/* Loading spinner — inline SVG, no external assets */}
                <svg
                  width="16"
                  height="16"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  strokeWidth="2"
                  style={{ animation: 'twelvify-spin 1s linear infinite' }}
                  aria-hidden="true"
                >
                  <circle cx="12" cy="12" r="10" strokeOpacity="0.25" />
                  <path d="M12 2a10 10 0 0 1 10 10" />
                </svg>
                Simplifying...
              </>
            ) : (
              <>
                {/* Spark icon — inline SVG */}
                <svg
                  width="16"
                  height="16"
                  viewBox="0 0 24 24"
                  fill="currentColor"
                  aria-hidden="true"
                >
                  <path d="M12 2L9.5 9.5 2 12l7.5 2.5L12 22l2.5-7.5L22 12l-7.5-2.5L12 2z" />
                </svg>
                Simplify
              </>
            )}
          </button>
          {/* CSS keyframe for spinner animation — injected once */}
          <style>{`
            @keyframes twelvify-spin {
              from { transform: rotate(0deg); }
              to { transform: rotate(360deg); }
            }
          `}</style>
        </div>
      );
    }
    ```

    Key requirements:
    - MUST use `popover="manual"` attribute — this places the element in the browser's top layer above all page content
    - ZERO custom z-index values — the Popover API handles layering natively
    - Loading spinner shown when `isLoading` is true (reads from chrome.storage via useStorageValue)
    - Button disappears when `selectedText` is empty (content script clears it on deselect)
    - Inline SVG icons only — no external image assets (avoids CSP issues)
    - Inline style object only — no external CSS file import (content script injection context)
    - The `onSimplify` callback is a prop — Phase 2 will connect it to the AI API call
  </action>
  <verify>
    Run `npm run build` — TypeScript must compile FloatingButton.tsx without errors. Check that the component imports useStorageValue correctly.
  </verify>
  <done>
    FloatingButton.tsx compiles without errors. Component renders null when selectedText is empty, renders button with Simplify label when text is selected, renders loading spinner when isLoading is true. Zero custom z-index values in the component.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement content script with text selection detection and button injection</name>
  <files>
    src/entrypoints/content.ts
  </files>
  <action>
    Create src/entrypoints/content.ts as the MV3 content script that runs on every webpage:

    ```typescript
    // src/entrypoints/content.ts
    // Runs on every webpage — detects text selection, injects floating button
    // Selection API: standard DOM text selection (shadow DOM excluded, deferred to Phase 4)

    import { createRoot } from 'react/client';
    import { createElement } from 'react';
    import { FloatingButton } from '../components/FloatingButton';
    import type { ExtensionMessage } from '../messaging/messages';

    export default defineContentScript({
      matches: ['<all_urls>'],
      runAt: 'document_idle',

      main() {
        // --- Inject floating button into page ---
        const container = document.createElement('div');
        container.id = 'twelvify-root';
        document.body.appendChild(container);

        const root = createRoot(container);

        function renderButton() {
          root.render(
            createElement(FloatingButton, {
              onSimplify: handleSimplify,
            })
          );
        }

        // Initial render (will show nothing until text is selected)
        renderButton();

        // Show popover after render
        function showPopover() {
          const popoverEl = document.getElementById('twelvify-floating-btn');
          if (popoverEl && 'showPopover' in popoverEl) {
            (popoverEl as HTMLElement & { showPopover(): void }).showPopover();
          }
        }

        function hidePopover() {
          const popoverEl = document.getElementById('twelvify-floating-btn');
          if (popoverEl && 'hidePopover' in popoverEl) {
            (popoverEl as HTMLElement & { hidePopover(): void }).hidePopover();
          }
        }

        // --- Text selection detection ---
        // Use selectionchange event (fires on any selection change)
        // Also listen for mouseup to catch rapid selections
        let selectionDebounce: ReturnType<typeof setTimeout> | null = null;

        function handleSelectionChange() {
          if (selectionDebounce) clearTimeout(selectionDebounce);

          selectionDebounce = setTimeout(() => {
            const selectedText = getSelectedText();

            if (selectedText && selectedText.length > 3) {
              // Send to background service worker for persistence
              const message: ExtensionMessage = {
                type: 'TEXT_SELECTED',
                text: selectedText,
                timestamp: Date.now(),
              };

              chrome.runtime.sendMessage(message, (response) => {
                if (chrome.runtime.lastError) {
                  // Service worker may have just restarted — not an error, retry once
                  chrome.runtime.sendMessage(message);
                  return;
                }
                if (response?.status === 'received') {
                  showPopover();
                }
              });
            } else {
              // Clear selection state and hide button
              const clearMessage: ExtensionMessage = { type: 'CLEAR_SELECTION' };
              chrome.runtime.sendMessage(clearMessage);
              hidePopover();
            }
          }, 50); // 50ms debounce — prevents flooding on drag selections
        }

        function getSelectedText(): string {
          // Standard Selection API for most page text
          const selection = window.getSelection();
          const text = selection?.toString().trim();

          // Handle textarea/input fields (getSelection() returns empty for these)
          if (!text) {
            const activeEl = document.activeElement;
            if (
              activeEl instanceof HTMLTextAreaElement ||
              activeEl instanceof HTMLInputElement
            ) {
              const start = activeEl.selectionStart ?? 0;
              const end = activeEl.selectionEnd ?? 0;
              return activeEl.value.slice(start, end).trim();
            }
          }

          return text ?? '';
        }

        // Register listeners at top level of main() — not inside async callbacks
        document.addEventListener('selectionchange', handleSelectionChange);
        document.addEventListener('mouseup', handleSelectionChange);

        // Hide button when user clicks outside
        document.addEventListener('click', (event) => {
          const target = event.target as HTMLElement;
          if (!target.closest('#twelvify-root')) {
            const selection = window.getSelection();
            if (!selection || selection.toString().trim().length <= 3) {
              const clearMessage: ExtensionMessage = { type: 'CLEAR_SELECTION' };
              chrome.runtime.sendMessage(clearMessage);
              hidePopover();
            }
          }
        });

        function handleSimplify() {
          // Phase 2 will implement the actual AI call here
          // Phase 1 stub: just log and set loading state
          const loadingMessage: ExtensionMessage = { type: 'SET_LOADING', isLoading: true };
          chrome.runtime.sendMessage(loadingMessage);

          // Simulate Phase 2 API call completion after 1s (stub only)
          setTimeout(() => {
            const doneMessage: ExtensionMessage = { type: 'SET_LOADING', isLoading: false };
            chrome.runtime.sendMessage(doneMessage);
          }, 1000);
        }
      },
    });
    ```

    Key requirements:
    - `matches: ['<all_urls>']` — runs on all pages
    - `runAt: 'document_idle'` — waits for DOM to be ready
    - BOTH selectionchange AND mouseup listeners registered (not just one — selectionchange fires during keyboard selection, mouseup catches end of mouse drag)
    - 50ms debounce on selection to prevent message flooding during drag selections
    - getSelectedText() handles BOTH regular DOM text (window.getSelection()) AND textarea/input fields (HTMLInputElement.selectionStart/End) — this is the EXTF-03 requirement for "diverse page structures"
    - showPopover()/hidePopover() calls the native Popover API
    - handleSimplify() is a stub that sets isLoading — Phase 2 replaces this with actual AI call
    - All listeners registered at top level of main(), not inside async functions
  </action>
  <verify>
    1. Run `npm run build` — exits 0, no TypeScript errors
    2. Verify content script is included in build output: `ls /Users/brunocampos/Twelvify/.output/chrome-mv3/content-scripts/` should show the content script
    3. Verify wxt.config.ts or generated manifest includes content_scripts with `matches: ["&lt;all_urls&gt;"]` and `run_at: "document_idle"`
    4. Load extension in Chrome (chrome://extensions → Load unpacked → .output/chrome-mv3/), navigate to any webpage, select text — floating "Simplify" button should appear in bottom-right corner within 200ms
    5. Verify button uses Popover API: in Chrome DevTools Elements panel, the #twelvify-floating-btn element should be visible in the top-layer section
  </verify>
  <done>
    Content script builds and runs on webpages. Selecting more than 3 characters of text on any standard webpage (news site, blog, GitHub, Twitter/X) causes the Simplify button to appear in bottom-right corner within 200ms. Deselecting text hides the button. Clicking Simplify button shows loading state for 1 second then returns to normal. Button renders correctly using Popover API (visible in Chrome DevTools top layer). Textarea/input text selection also triggers the button.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` exits 0 with no TypeScript errors in content.ts or FloatingButton.tsx
2. Extension loaded in Chrome shows no errors on chrome://extensions page
3. On a news article (e.g., any static website): select 10+ characters of text → Simplify button appears within 200ms in bottom-right
4. Click outside selection → button disappears
5. Click Simplify → button shows loading state (spinner + "Simplifying...") for 1 second, then returns to normal
6. In Chrome DevTools Elements panel with floating button visible: confirms #twelvify-floating-btn is in the top layer (Popover API working)
7. Selecting text in a textarea on a page → button also appears
8. Zero z-index properties in FloatingButton.tsx styles
</verification>

<success_criteria>
- Content script detects text selection across standard DOM pages (news, blogs, GitHub, Twitter/X, forums)
- Floating button appears using Popover API (top layer, no z-index)
- Loading indicator state wired to chrome.storage.local isLoading flag
- handleSimplify() stub ready for Phase 2 to replace with actual AI call
- All 6 Phase 1 requirements addressed: EXTF-01 (Plan 01), EXTF-02 (Plan 02), EXTF-03 + SIMP-01 + DISP-03 (this plan), EXTF-04 (Plan 01)
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-text-selection/01-03-SUMMARY.md`
</output>
