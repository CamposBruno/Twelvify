---
phase: 03-personalization-ux-polish
plan: 02
type: execute
wave: 2
depends_on: [03-01]
files_modified:
  - src/components/FloatingButton.tsx
  - src/utils/undoStack.ts
autonomous: true
requirements: [SIMP-04, PERS-01]

must_haves:
  truths:
    - "FloatingButton shows the age-level-lower label (e.g. setting=12 → button says 'Explain like I'm 5')"
    - "FloatingButton wraps around from Baby to 'Explain like I'm a Big Boy'"
    - "FloatingButton transitions to undo mode after simplification (shows Undo button)"
    - "Undo button is visible as long as any simplification is present on the page"
    - "UndoStack class is available as a module for content.ts to import"
  artifacts:
    - path: "src/utils/undoStack.ts"
      provides: "UndoStack class with push/pop/revert/clear/isEmpty"
      exports: ["UndoStack"]
    - path: "src/components/FloatingButton.tsx"
      provides: "Extended FloatingButton with undo mode and age-level cycling label"
      contains: "onUndo"
  key_links:
    - from: "src/components/FloatingButton.tsx"
      to: "chrome.storage.sync"
      via: "useStorageSyncValue for tone"
      pattern: "useStorageSyncValue"
    - from: "src/components/FloatingButton.tsx"
      to: "undoStack"
      via: "hasUndo prop controls undo mode display"
      pattern: "hasUndo"
---

<objective>
Evolve FloatingButton into the Phase 3 multi-mode button and create the undo stack utility.

Purpose: The floating button serves three roles in Phase 3 — (1) simplify trigger showing the age-level-lower label, (2) undo trigger after simplification, (3) hover tooltip for keyboard shortcut discoverability. The undo stack is a pure utility class that content.ts will use to store original text for reverting.

Output: src/utils/undoStack.ts (new); FloatingButton.tsx extended with undo mode + age-level cycling label + hover tooltip.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@src/components/FloatingButton.tsx
@src/storage/types.ts
@src/storage/useStorage.ts
@.planning/phases/03-personalization-ux-polish/03-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create UndoStack utility module</name>
  <files>src/utils/undoStack.ts</files>
  <action>
Create `src/utils/undoStack.ts` (new file — create the `src/utils/` directory if it doesn't exist).

Implement `UndoStack` as a plain class (functional patterns preferred but class is appropriate for stack state management):

```typescript
export interface UndoEntry {
  originalText: string;
  simplifiedText: string;
  textNode: Text;  // Direct reference to the DOM text node that was replaced
}

export class UndoStack {
  private stack: UndoEntry[] = [];

  push(entry: UndoEntry): void { ... }
  pop(): UndoEntry | undefined { ... }
  peek(): UndoEntry | undefined { ... }
  isEmpty(): boolean { ... }
  size(): number { ... }
  clear(): void { ... }

  /** Revert the most recent simplification by restoring the original text in the DOM */
  revertLast(): boolean {
    const entry = this.pop();
    if (!entry) return false;
    // Replace the text node content directly
    entry.textNode.textContent = entry.originalText;
    return true;
  }
}
```

Key implementation notes:
- `textNode` stores a direct reference to the live DOM Text node that was mutated during streaming (the `textNode` variable in the Phase 2 SSE streaming code in content.ts). This avoids needing Range serialization — the node reference is valid as long as the page hasn't navigated.
- `revertLast()` returns false if stack is empty (no-op, safe to call unconditionally).
- Stack is module-scoped, meaning content.ts creates ONE instance per page load (not per simplification).

Add JSDoc comments noting that this stack is in-memory only — it MUST NOT be persisted to chrome.storage. It clears on page navigation (content script is destroyed).
  </action>
  <verify>
Run `npx tsc --noEmit` from project root — no errors. File exists at `src/utils/undoStack.ts`. Grep for `export class UndoStack` confirms export.
  </verify>
  <done>undoStack.ts compiles cleanly; UndoStack class exported with push/pop/revertLast/isEmpty/clear/size methods; UndoEntry interface exported.</done>
</task>

<task type="auto">
  <name>Task 2: Extend FloatingButton with undo mode and age-level cycling label</name>
  <files>src/components/FloatingButton.tsx</files>
  <action>
Extend `src/components/FloatingButton.tsx` with undo mode and age-level label. Preserve ALL existing behavior (error state, shake animation, loading state, visibility, z-index). Key changes:

**New props:**
```typescript
interface FloatingButtonProps {
  onSimplify: () => void;
  onUndo?: () => void;        // Called when undo button clicked
  hasUndo?: boolean;          // True when undo stack has entries — shows undo mode
}
```

**Age-level cycling label:**

Read `tone` from `useStorageSyncValue<ToneLevel>('tone', 12)` (import from `../storage/useStorage` and `../storage/types`).

Define a helper `getButtonLabel(tone: ToneLevel): string` that returns the ONE-LEVEL-LOWER label:
- current=big_boy → "Explain like I'm 18"
- current=18 → "Explain like I'm 12"
- current=12 → "Explain like I'm 5"
- current=5 → "Explain like I'm a Baby"
- current=baby → "Explain like I'm a Big Boy" (wrap-around)

The button shows this label when NOT loading and NOT in undo mode. When loading, show "Simplifying..." (unchanged).

**Undo mode:**

When `hasUndo === true` and NOT loading:
- Button text: "↩ Undo" (use ↩ Unicode, no SVG needed)
- Button background: '#10b981' (green — distinct from indigo simplify button)
- Button onClick: calls `onUndo?.()` instead of `onSimplify`
- aria-label: "Revert to original text"

Priority hierarchy (highest to lowest):
1. `isLoading` → show spinner + "Simplifying..." (existing behavior, unchanged)
2. `errorState` → yellow button + ErrorTooltip (existing behavior, unchanged)
3. `hasUndo` → green undo button (new)
4. default → age-level label + indigo button (modified from plain "Simplify")

**Hover tooltip:**

Add a title attribute to the button: when NOT loading and NOT hasUndo:
`title={\`Simplify selected text (Ctrl+Shift+1)\`}`

This provides keyboard shortcut discoverability on hover without any new component.

**Important:** Keep the SVG spark icon when showing the age-level label (not in undo mode). Remove the spark icon in undo mode (just text). Keep ErrorTooltip rendering unconditionally gated on `errorState` (unchanged).
  </action>
  <verify>
Run `npx tsc --noEmit` — no errors. Manually check: FloatingButton.tsx has `onUndo`, `hasUndo` props. `getButtonLabel` covers all 5 ToneLevel values. `useStorageSyncValue` is imported.
  </verify>
  <done>FloatingButton compiles cleanly; accepts hasUndo/onUndo props; shows age-level cycling label by default; shows green undo button when hasUndo=true; hover title shows keyboard shortcut; all existing error/loading/shake behavior preserved.</done>
</task>

</tasks>

<verification>
Run `npx tsc --noEmit` — zero TypeScript errors.
Grep `src/components/FloatingButton.tsx` for `hasUndo` — must exist.
Grep `src/components/FloatingButton.tsx` for `getButtonLabel` — must exist.
Grep `src/utils/undoStack.ts` for `export class UndoStack` — must exist.
</verification>

<success_criteria>
- undoStack.ts exists with UndoStack class (push/pop/revertLast/isEmpty/clear/size)
- FloatingButton.tsx shows age-level cycling label (one-level-lower from current tone)
- FloatingButton.tsx enters green undo mode when hasUndo=true
- All existing FloatingButton behavior (error state, shake, loading, visibility) preserved
- TypeScript compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/03-personalization-ux-polish/03-02-SUMMARY.md` following the summary template.
</output>
