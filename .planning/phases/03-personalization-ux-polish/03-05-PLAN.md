---
phase: 03-personalization-ux-polish
plan: 05
type: execute
wave: 3
depends_on: [03-01]
files_modified:
  - src/utils/onboarding.ts
  - src/components/OnboardingPrompt.tsx
  - src/components/FloatingPopup.tsx
  - src/entrypoints/popup/SettingsPanel.tsx
  - src/entrypoints/popup/App.tsx
autonomous: true
requirements: [PERS-02, PERS-03, DISP-02]

must_haves:
  truths:
    - "getNextOnboardingPrompt returns tone prompt after 3rd simplification, depth after 6th, profession after 9th"
    - "Dismissed prompts never reappear — stored in chrome.storage.sync dismissedOnboardingPrompts"
    - "OnboardingPrompt renders inline below simplified text with dismiss button"
    - "FloatingPopup renders simplified text in a fixed-position card near the viewport bottom-right"
    - "Extension popup shows SettingsPanel with: tone selector, depth selector, profession text input, display mode toggle"
    - "Saving any setting in SettingsPanel writes to chrome.storage.sync immediately"
  artifacts:
    - path: "src/utils/onboarding.ts"
      provides: "getNextOnboardingPrompt and PROMPTS definitions"
      exports: ["getNextOnboardingPrompt", "OnboardingPromptDef"]
    - path: "src/components/OnboardingPrompt.tsx"
      provides: "React component for inline preference prompts"
      exports: ["OnboardingPrompt"]
    - path: "src/components/FloatingPopup.tsx"
      provides: "React component for popup display mode"
      exports: ["FloatingPopup"]
    - path: "src/entrypoints/popup/SettingsPanel.tsx"
      provides: "Settings UI component for all user preferences"
      exports: ["SettingsPanel"]
    - path: "src/entrypoints/popup/App.tsx"
      provides: "Extension popup root with SettingsPanel embedded"
  key_links:
    - from: "src/entrypoints/popup/SettingsPanel.tsx"
      to: "chrome.storage.sync"
      via: "useStorageSyncValue for each setting"
      pattern: "useStorageSyncValue"
    - from: "src/utils/onboarding.ts"
      to: "src/components/OnboardingPrompt.tsx"
      via: "OnboardingPromptDef type flows into component props"
      pattern: "OnboardingPromptDef"
---

<objective>
Build all new UI components and settings panel for Phase 3 personalization.

Purpose: Three new components and one utility complete the Phase 3 UI surface: OnboardingPrompt (inline preference discovery after simplification), FloatingPopup (alternative display mode card), and SettingsPanel (all user preferences in the extension popup). These are isolated from content.ts — they're React components and pure logic modules that content.ts and the popup will import.

Output: src/utils/onboarding.ts; src/components/OnboardingPrompt.tsx; src/components/FloatingPopup.tsx; src/entrypoints/popup/SettingsPanel.tsx; updated src/entrypoints/popup/App.tsx.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@src/storage/types.ts
@src/storage/useStorage.ts
@src/entrypoints/popup/App.tsx
@.planning/phases/03-personalization-ux-polish/03-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create onboarding utility, OnboardingPrompt and FloatingPopup components</name>
  <files>src/utils/onboarding.ts, src/components/OnboardingPrompt.tsx, src/components/FloatingPopup.tsx</files>
  <action>
**src/utils/onboarding.ts (new):**

```typescript
export interface OnboardingPromptDef {
  id: 'tone' | 'depth' | 'profession';
  title: string;
  description: string;
  triggerAt: number;  // simplifyCount threshold to first show
}

export const PROMPTS: OnboardingPromptDef[] = [
  {
    id: 'tone',
    title: 'How old should I talk?',
    description: 'Set the age-level you prefer. We default to 12 — that\'s our thing.',
    triggerAt: 3,
  },
  {
    id: 'depth',
    title: 'How deep should I go?',
    description: 'Light = quick overview. Medium = balanced. Detailed = full explanation.',
    triggerAt: 6,
  },
  {
    id: 'profession',
    title: 'What\'s your background?',
    description: 'Tell me what you do — I\'ll use relatable analogies. ("I\'m a nurse", "I do marketing")',
    triggerAt: 9,
  },
];

/**
 * Returns the next onboarding prompt to show, or null if none are pending.
 * A prompt is shown if: simplifyCount >= prompt.triggerAt AND prompt.id not in dismissedPrompts.
 * Returns the FIRST eligible prompt (respects PROMPTS order: tone → depth → profession).
 */
export function getNextOnboardingPrompt(
  simplifyCount: number,
  dismissedPrompts: string[]
): OnboardingPromptDef | null {
  const eligible = PROMPTS.filter(
    (p) => simplifyCount >= p.triggerAt && !dismissedPrompts.includes(p.id)
  );
  return eligible[0] ?? null;
}
```

**src/components/OnboardingPrompt.tsx (new):**

React component displayed inline below simplified text. Props:
```typescript
interface OnboardingPromptProps {
  prompt: OnboardingPromptDef;
  onDismiss: () => void;  // Called when user clicks "Not now" — forever
  onSelect?: (value: string) => void;  // Called when user picks a value
}
```

Render as a small card (inline, not modal). Use inline styles (no Tailwind — content scripts can't import CSS).

Style: white background, 1px solid #e5e7eb border, 8px border-radius, 12px padding, 13px system-ui font, max-width 320px. Position: rendered by content.ts as a separate React root below the simplified text span.

For tone prompt: show 5 buttons (Baby, 5, 12, 18, Big Boy) — clicking one calls `onSelect(value)`.
For depth prompt: show 3 buttons (Light, Medium, Detailed).
For profession prompt: show a text input + "Save" button. Input placeholder: "I'm a nurse, I do marketing...".
For all prompts: "Not now →" small text link that calls `onDismiss()`.

Show prompt title and description above the controls.

**src/components/FloatingPopup.tsx (new):**

React component for alternative display mode. Replaces the stub created in Plan 04 (if stub was created).

Props:
```typescript
interface FloatingPopupProps {
  simplifiedText: string;
  onClose: () => void;
}
```

Render as a fixed-position card:
- position: fixed, bottom: 80px, right: 24px (above FloatingButton area)
- background: white, border: 1px solid #e5e7eb, border-radius: 12px, padding: 16px
- max-width: 360px, max-height: 300px, overflow-y: auto
- box-shadow: 0 8px 24px rgba(0,0,0,0.12)
- z-index: 2147483646 (just below FloatingButton's 2147483647)
- Title: "Simplified" in 12px uppercase tracking text
- Body: simplifiedText in 14px system-ui
- Close button (×) top-right corner, calls onClose()
- Animation: fade in via CSS opacity transition (0 → 1 in 0.2s)
  </action>
  <verify>
Run `npx tsc --noEmit` — no errors.
Grep `src/utils/onboarding.ts` for `getNextOnboardingPrompt` — must exist.
Grep `src/components/OnboardingPrompt.tsx` for `onDismiss` — must exist.
Grep `src/components/FloatingPopup.tsx` for `simplifiedText` — must exist.
  </verify>
  <done>onboarding.ts compiles with getNextOnboardingPrompt; OnboardingPrompt.tsx renders tone/depth/profession variants with dismiss; FloatingPopup.tsx renders fixed-position card with close button; all TypeScript clean.</done>
</task>

<task type="auto">
  <name>Task 2: Build SettingsPanel and update popup App.tsx</name>
  <files>src/entrypoints/popup/SettingsPanel.tsx, src/entrypoints/popup/App.tsx</files>
  <action>
**src/entrypoints/popup/SettingsPanel.tsx (new):**

Full settings UI for all user preferences. Uses `useStorageSyncValue` for live read/write.

Sections and controls:

1. **Age Level (Tone):** Label "Age Level". Five buttons: Baby | 5 | 12 | 18 | Big Boy. Active button highlighted with indigo (#6366f1) background + white text. Reads/writes `tone` via `useStorageSyncValue<ToneLevel>('tone', 12)`. Below buttons show description: "Sets how simply I explain things. 12 = default Twelveify level."

2. **Depth:** Label "Explanation Depth". Three buttons: Light | Medium | Detailed. Active = highlighted. Reads/writes `depth` via `useStorageSyncValue<string>('depth', 'medium')`.

3. **Background:** Label "Your Background (optional)". Text input, placeholder "e.g. I'm a nurse, I do marketing". Reads/writes `profession` via `useStorageSyncValue<string>('profession', '')`. Helper text: "I'll use relatable analogies when explaining concepts."

4. **Display Mode:** Label "Display Mode". Two radio buttons: "Replace in-page" (default) and "Show in popup". Reads/writes `displayMode` via `useStorageSyncValue<string>('displayMode', 'replace')`.

5. **Keyboard Shortcut:** Label "Keyboard Shortcut". Shows current shortcut (default: Ctrl+Shift+1). Text input to change it. On save: writes `keyboardShortcut` to `useStorageSyncValue<string>('keyboardShortcut', 'Ctrl+Shift+1')`. Note below: "Chrome manages the actual key binding. Update in chrome://extensions/shortcuts if needed."

Use inline styles throughout (popup IS in an extension page so CSS could work, but inline is safer and consistent with project patterns). Style: clean, minimal, white background, section labels in 11px uppercase gray, controls with generous padding.

Initialize sync defaults on popup open: call `initSyncDefaults(DEFAULT_SETTINGS)` in a `useEffect(() => { initSyncDefaults(DEFAULT_SETTINGS); }, [])` at the top of SettingsPanel.

Import `useStorageSyncValue`, `initSyncDefaults` from `'../../storage/useStorage'`.
Import `DEFAULT_SETTINGS`, `ToneLevel` from `'../../storage/types'`.

**src/entrypoints/popup/App.tsx (update):**

Replace the placeholder content with actual UI:

```typescript
import React from 'react';
import { SettingsPanel } from './SettingsPanel';

function App(): React.ReactElement {
  return (
    <div style={{ width: '320px', padding: '16px', fontFamily: 'system-ui, -apple-system, sans-serif' }}>
      <div style={{ display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '16px' }}>
        {/* Spark icon */}
        <svg width="20" height="20" viewBox="0 0 24 24" fill="#6366f1" aria-hidden="true">
          <path d="M12 2L9.5 9.5 2 12l7.5 2.5L12 22l2.5-7.5L22 12l-7.5-2.5L12 2z" />
        </svg>
        <h1 style={{ margin: 0, fontSize: '18px', fontWeight: '700', color: '#111827' }}>Twelveify</h1>
      </div>
      <SettingsPanel />
    </div>
  );
}

export default App;
```
  </action>
  <verify>
Run `npx tsc --noEmit` — no errors.
Grep `src/entrypoints/popup/SettingsPanel.tsx` for `useStorageSyncValue` — must appear 5 times (one per setting).
Grep `src/entrypoints/popup/App.tsx` for `SettingsPanel` — must import and render it.
  </verify>
  <done>SettingsPanel.tsx renders all 5 settings sections with live sync storage; App.tsx embeds SettingsPanel with Twelveify header; TypeScript compiles cleanly.</done>
</task>

</tasks>

<verification>
Run `npx tsc --noEmit` — zero errors.
Confirm 5 new/modified files exist: onboarding.ts, OnboardingPrompt.tsx, FloatingPopup.tsx, SettingsPanel.tsx, App.tsx.
Grep SettingsPanel.tsx for `initSyncDefaults` — must be called in useEffect.
</verification>

<success_criteria>
- onboarding.ts: getNextOnboardingPrompt triggers tone at 3, depth at 6, profession at 9; respects dismissedPrompts
- OnboardingPrompt.tsx: renders inline controls for tone (5 buttons) / depth (3 buttons) / profession (text input); has "Not now" dismiss link
- FloatingPopup.tsx: fixed-position card with simplifiedText, close button, z-index below FloatingButton
- SettingsPanel.tsx: all 5 settings with live sync storage reads/writes; initSyncDefaults called on mount
- App.tsx: Twelveify header + SettingsPanel rendered
- TypeScript compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/03-personalization-ux-polish/03-05-SUMMARY.md` following the summary template.
</output>
