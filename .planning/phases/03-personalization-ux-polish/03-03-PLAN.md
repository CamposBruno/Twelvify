---
phase: 03-personalization-ux-polish
plan: 03
type: execute
wave: 2
depends_on: [03-01]
files_modified:
  - wxt.config.ts
  - src/messaging/messages.ts
  - src/entrypoints/background.ts
autonomous: true
requirements: [SIMP-03]

must_haves:
  truths:
    - "Ctrl+Shift+1 is registered as the default simplify keyboard shortcut"
    - "Background service worker listens for chrome.commands 'simplify-hotkey' and routes to active tab's content script"
    - "SIMPLIFY_HOTKEY message type exists in the messaging contract"
    - "Background.ts handles SIMPLIFY_HOTKEY routing without breaking existing message handlers"
  artifacts:
    - path: "wxt.config.ts"
      provides: "commands block with simplify-hotkey Ctrl+Shift+1"
      contains: "simplify-hotkey"
    - path: "src/messaging/messages.ts"
      provides: "SimplifyHotkeyMessage type in union"
      contains: "SIMPLIFY_HOTKEY"
    - path: "src/entrypoints/background.ts"
      provides: "chrome.commands.onCommand handler routing hotkey to content script"
      contains: "chrome.commands.onCommand"
  key_links:
    - from: "wxt.config.ts"
      to: "chrome.commands"
      via: "manifest commands block"
      pattern: "simplify-hotkey"
    - from: "src/entrypoints/background.ts"
      to: "src/entrypoints/content.ts"
      via: "chrome.tabs.sendMessage SIMPLIFY_HOTKEY"
      pattern: "SIMPLIFY_HOTKEY"
---

<objective>
Wire up the Ctrl+Shift+1 keyboard shortcut through the Chrome commands system.

Purpose: The shortcut must be registered in the manifest so Chrome recognizes it globally (not just when the extension popup is open). When triggered, it routes through background.ts to the active tab's content script, which then calls handleSimplify(). This plan covers the plumbing only — content.ts handles the SIMPLIFY_HOTKEY message in Plan 04.

Output: Updated wxt.config.ts with commands block; updated messages.ts with SIMPLIFY_HOTKEY type; updated background.ts with chrome.commands.onCommand handler.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@wxt.config.ts
@src/messaging/messages.ts
@src/entrypoints/background.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Register keyboard shortcut in manifest and add SIMPLIFY_HOTKEY message type</name>
  <files>wxt.config.ts, src/messaging/messages.ts</files>
  <action>
**wxt.config.ts:** Add a `commands` block inside the `manifest` object:

```typescript
commands: {
  'simplify-hotkey': {
    suggested_key: {
      default: 'Ctrl+Shift+1',
      mac: 'Command+Shift+1'
    },
    description: 'Simplify selected text'
  }
}
```

Note: `suggested_key` uses an object with `default` and `mac` keys in the Chrome commands API (not a flat string). Mac uses Command instead of Ctrl. Keep all existing manifest config (name, version, permissions, host_permissions, CSP, action) untouched.

**src/messaging/messages.ts:** Add `SimplifyHotkeyMessage` type and add `'SIMPLIFY_HOTKEY'` to the `MessageType` union and `ExtensionMessage` union:

```typescript
export interface SimplifyHotkeyMessage {
  type: 'SIMPLIFY_HOTKEY';
}
```

Add `| SimplifyHotkeyMessage` to `ExtensionMessage` union. Add `'SIMPLIFY_HOTKEY'` to `MessageType` union. Keep all existing message types unchanged.
  </action>
  <verify>
Run `npx tsc --noEmit` — no errors. Grep `wxt.config.ts` for `simplify-hotkey` — must exist. Grep `src/messaging/messages.ts` for `SIMPLIFY_HOTKEY` — must exist.
  </verify>
  <done>wxt.config.ts has commands block with simplify-hotkey; messages.ts has SimplifyHotkeyMessage type and SIMPLIFY_HOTKEY in ExtensionMessage union; TypeScript compiles cleanly.</done>
</task>

<task type="auto">
  <name>Task 2: Add chrome.commands.onCommand handler to background.ts</name>
  <files>src/entrypoints/background.ts</files>
  <action>
Extend `src/entrypoints/background.ts` to register a `chrome.commands.onCommand` listener at the top level of `defineBackground()`.

Add AFTER the existing `chrome.runtime.onMessage.addListener` call (keep that unchanged):

```typescript
// Keyboard shortcut handler — routes Ctrl+Shift+1 to active tab's content script
// CRITICAL: Registered at top level (not inside async) — service worker restart safety
chrome.commands.onCommand.addListener((command) => {
  if (command === 'simplify-hotkey') {
    chrome.tabs.query({ active: true, currentWindow: true }, (tabs) => {
      const activeTab = tabs[0];
      if (activeTab?.id) {
        chrome.tabs.sendMessage(
          activeTab.id,
          { type: 'SIMPLIFY_HOTKEY' } satisfies SimplifyHotkeyMessage,
          () => {
            // Suppress "Could not establish connection" error if content script not injected
            // (e.g., on chrome:// pages where content scripts cannot run)
            if (chrome.runtime.lastError) { /* intentionally silent */ }
          }
        );
      }
    });
  }
});
```

Import `SimplifyHotkeyMessage` from `'../messaging/messages'` at the top of the file (add to existing import).

Also add 'SIMPLIFY_HOTKEY' case to the `handleMessage` switch statement that simply calls `sendResponse({ status: 'received' })` — this prevents "Unknown message type" errors if the message routes back through the background for any reason.
  </action>
  <verify>
Run `npx tsc --noEmit` — no errors. Grep `background.ts` for `chrome.commands.onCommand` — must exist. Grep `background.ts` for `SIMPLIFY_HOTKEY` — must exist in both the listener and the switch case.
  </verify>
  <done>background.ts has chrome.commands.onCommand listener at top level; SIMPLIFY_HOTKEY routing to active tab content script implemented; switch case handles SIMPLIFY_HOTKEY; TypeScript compiles cleanly.</done>
</task>

</tasks>

<verification>
Run `npx tsc --noEmit` — zero errors.
Grep `wxt.config.ts` for `simplify-hotkey` and `suggested_key` — both must exist.
Grep `src/messaging/messages.ts` for `SIMPLIFY_HOTKEY` — must be in type union.
Grep `src/entrypoints/background.ts` for `chrome.commands.onCommand` — must exist at top level of defineBackground().
</verification>

<success_criteria>
- wxt.config.ts registers simplify-hotkey command with Ctrl+Shift+1 default (Command+Shift+1 on Mac)
- messages.ts has SimplifyHotkeyMessage and SIMPLIFY_HOTKEY in ExtensionMessage union
- background.ts has chrome.commands.onCommand listener routing hotkey to active tab content script
- All existing background.ts message handlers unchanged
- TypeScript compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/03-personalization-ux-polish/03-03-SUMMARY.md` following the summary template.
</output>
