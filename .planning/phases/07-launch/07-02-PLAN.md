---
phase: 07-launch
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - landing/vercel.json
  - landing/.vercelignore
autonomous: true
requirements:
  - DEPLOY-01
  - DEPLOY-02

must_haves:
  truths:
    - "A production build can be created locally with `npm run build`"
    - "Vercel knows to build from the landing/ subdirectory"
    - "Deploys only trigger on git tags matching `website_*` — not on branch pushes"
    - "No preview deploys are created for pull requests"
    - "www.twelvify.com redirects to twelvify.com"
  artifacts:
    - path: "landing/vercel.json"
      provides: "Vercel project configuration with build settings, redirect rules, and deploy hooks"
      contains: "rewrites"
    - path: "landing/.vercelignore"
      provides: "Excludes dev-only files from Vercel upload"
  key_links:
    - from: "landing/vercel.json"
      to: "Vercel platform"
      via: "rootDirectory: landing/ set in Vercel project settings (human step in checkpoint)"
      pattern: "vercel.json"
---

<objective>
Configure the production build pipeline and Vercel deployment so the landing page deploys cleanly on git tag push (`website_*`) with no preview deployments and a www-to-root redirect.

Purpose: Ship-ready deploy pipeline — tag a release, Vercel builds and publishes automatically.
Output: vercel.json config + .vercelignore + instructions for the one-time Vercel project setup.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create vercel.json with build config, redirects, and deploy controls</name>
  <files>
    landing/vercel.json
    landing/.vercelignore
  </files>
  <action>
**Create `landing/vercel.json`:**

```json
{
  "$schema": "https://openapi.vercel.sh/vercel.json",
  "buildCommand": "npm run build",
  "outputDirectory": "dist",
  "installCommand": "npm install",
  "framework": "vite",
  "redirects": [
    {
      "source": "/:path*",
      "has": [{ "type": "host", "value": "www.twelvify.com" }],
      "destination": "https://twelvify.com/:path*",
      "permanent": true
    }
  ],
  "headers": [
    {
      "source": "/assets/(.*)",
      "headers": [
        { "key": "Cache-Control", "value": "public, max-age=31536000, immutable" }
      ]
    },
    {
      "source": "/(.*)",
      "headers": [
        { "key": "X-Content-Type-Options", "value": "nosniff" },
        { "key": "X-Frame-Options", "value": "DENY" },
        { "key": "Referrer-Policy", "value": "strict-origin-when-cross-origin" }
      ]
    }
  ]
}
```

Key decisions:
- `outputDirectory: "dist"` — Vite's default output directory
- `framework: "vite"` — tells Vercel to use Vite-optimized build pipeline
- Redirect rule: any request to www.twelvify.com → twelvify.com with 301 (permanent)
- Cache headers: Vite hashes asset filenames → safe to set `immutable` 1-year cache on `/assets/`
- Security headers: X-Content-Type-Options, X-Frame-Options, Referrer-Policy as baseline hardening

**Create `landing/.vercelignore`:**

```
code.html
```

This excludes the reference HTML file (`landing/code.html`) from being uploaded to Vercel — it is a dev artifact, not a production file.

**Note on deploy-on-tag (git tag `website_*`):**

Vercel does not natively support deploy-on-tag via vercel.json — this is configured in the Vercel Dashboard under Project Settings → Git → "Deploy Hooks" or via the Vercel CLI `--only-on-tag` flag. The SUMMARY for this plan must document the exact Vercel Dashboard steps required so the checkpoint in Plan 03 can guide the user through it.

The setting is: In Vercel Dashboard → Project → Settings → Git → uncheck "Automatically expose System Environment Variables" and in the "Ignored Build Step" field enter:

```
[ "$VERCEL_GIT_COMMIT_REF" != "main" ] && [[ "$VERCEL_GIT_COMMIT_TAG" != website_* ]]
```

This shell expression tells Vercel to skip the build unless the git tag matches `website_*`. Document this in the SUMMARY.
  </action>
  <verify>
1. File exists: `cat landing/vercel.json` — valid JSON with redirects and headers
2. File exists: `cat landing/.vercelignore`
3. Valid JSON: `node -e "JSON.parse(require('fs').readFileSync('landing/vercel.json','utf8'))" && echo "valid"`
4. Production build still works: `cd landing && npm run build`
  </verify>
  <done>
- landing/vercel.json is valid JSON with buildCommand, outputDirectory, redirects (www → root), and cache/security headers
- landing/.vercelignore excludes code.html
- `npm run build` still succeeds (no build regression from config files)
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify production build output quality</name>
  <files>
    landing/vite.config.ts
  </files>
  <action>
Run a production build and inspect the output to confirm Vite's defaults produce an optimised bundle. Check:

```bash
cd landing && npm run build && ls -lh dist/assets/
```

Vite by default:
- Minifies JS via esbuild
- Tree-shakes unused imports
- Hashes filenames for cache busting
- Splits vendor chunks

If the output shows a single large `index-[hash].js` file over 200KB (uncompressed), add manual chunk splitting to `vite.config.ts`:

```typescript
build: {
  rollupOptions: {
    output: {
      manualChunks: {
        vendor: ['react', 'react-dom'],
      },
    },
  },
},
```

Only add this if the bundle inspection reveals a problem. If the default output is reasonable (main JS < 150KB), leave vite.config.ts unchanged.

Also verify:
- CSS is extracted to a separate file (not inlined in JS)
- Assets directory contains hashed filenames

Run `du -sh dist/` and `du -sh dist/assets/*` to get size report. Include sizes in SUMMARY.
  </action>
  <verify>
1. `cd landing && npm run build` exits 0
2. `ls dist/assets/` shows hashed JS and CSS files
3. No file in dist/assets/ is > 300KB (uncompressed)
  </verify>
  <done>
Production build succeeds, assets are hashed, and the JS bundle is reasonably sized. If chunk splitting was needed, vite.config.ts is updated. Sizes documented in SUMMARY.
  </done>
</task>

</tasks>

<verification>
Run: `cd landing && npm run build && du -sh dist/ && ls -lh dist/assets/`
Confirm: Build exits 0, dist/assets/ contains hashed filenames, no file >300KB uncompressed.
Confirm: `node -e "JSON.parse(require('fs').readFileSync('landing/vercel.json','utf8'))" && echo valid`
</verification>

<success_criteria>
vercel.json is committed with correct build config (rootDirectory landing/, output dist/, www redirect, cache headers). Production build succeeds cleanly. Vite bundle sizes are within acceptable range. Deploy-on-tag instructions are documented in SUMMARY for the human Vercel setup step.
</success_criteria>

<output>
After completion, create `.planning/phases/07-launch/07-02-SUMMARY.md` following the summary template.

**IMPORTANT:** The SUMMARY must include a "Vercel Project Setup" section with the exact steps to:
1. Create a Vercel project pointing to this git repo
2. Set the Root Directory to `landing/`
3. Configure the "Ignored Build Step" command for tag-based deploys
4. Set no preview deploys on PRs

This will be referenced in Plan 03's checkpoint task.
</output>
