---
phase: 09-backend-production-deploy
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/src/index.ts
  - backend/src/routes/health.ts
  - backend/src/config/env.ts
  - backend/src/config/constants.ts
  - backend/src/middleware/rateLimit.ts
autonomous: true
requirements: [DEPL-02, DEPL-03, DEPL-05, DEPL-06]

must_haves:
  truths:
    - "Backend handles SIGTERM by stopping new connections and cleanly exiting within 30 seconds"
    - "/health endpoint returns 200 with status, version (gitSha+buildTime), uptime, memory, and anthropic connectivity check"
    - "/health endpoint returns 503 if Anthropic API call fails"
    - "CORS allows multiple comma-separated origins from ALLOWED_ORIGINS env var (chrome-extension://* and https://twelvify.com)"
    - "Rate limiter is set to 30 requests per minute per IP (down from 100/hr)"
  artifacts:
    - path: "backend/src/index.ts"
      provides: "Express server with SIGTERM/SIGINT graceful shutdown, server.close() + 30s force-exit"
      contains: "process.on('SIGTERM'"
    - path: "backend/src/routes/health.ts"
      provides: "Deep health check endpoint with Anthropic API ping, version info, memory stats"
      exports: ["healthRouter"]
    - path: "backend/src/config/env.ts"
      provides: "Env schema updated: ALLOWED_ORIGINS (plural, comma-separated), BUILD_TIMESTAMP, GIT_SHA"
    - path: "backend/src/config/constants.ts"
      provides: "RATE_LIMIT updated to 30/min"
  key_links:
    - from: "backend/src/index.ts"
      to: "process.on('SIGTERM')"
      via: "gracefulShutdown function closes server then exits"
      pattern: "process\\.on\\('SIGTERM'"
    - from: "backend/src/routes/health.ts"
      to: "openai.models.list()"
      via: "async health handler makes API call and returns 503 on failure"
      pattern: "openai\\.models\\.list"
    - from: "backend/src/index.ts"
      to: "ALLOWED_ORIGINS env var"
      via: "cors() with origin callback checking parsed allow list"
      pattern: "allowedOrigins\\.includes"
---

<objective>
Harden the Express backend for production: add graceful shutdown, upgrade the health endpoint to verify Anthropic API connectivity, and replace the wildcard CORS config with an environment-driven multi-origin allow list. Also reduce rate limit to 30 req/min.

Purpose: Prepares backend code for safe zero-downtime deploys on Render. Without SIGTERM handling, in-flight SSE streams are killed. Without deep health checks, Render can't detect expired API keys. Without strict CORS, any site can drain Anthropic API quota.

Output: Production-ready backend code committed to main; render.yaml and extension URL wiring done in Plan 02.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-backend-production-deploy/09-CONTEXT.md
@.planning/phases/09-backend-production-deploy/09-RESEARCH.md
@backend/src/index.ts
@backend/src/routes/health.ts
@backend/src/config/env.ts
@backend/src/config/constants.ts
@backend/src/middleware/rateLimit.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add graceful SIGTERM/SIGINT shutdown to index.ts and replace CORS with multi-origin callback</name>
  <files>backend/src/index.ts</files>
  <action>
Rewrite backend/src/index.ts to:

1. Capture the server reference from app.listen():
   ```typescript
   const server = app.listen(port, () => { ... });
   ```

2. Add isShuttingDown flag and gracefulShutdown function:
   ```typescript
   let isShuttingDown = false;

   const gracefulShutdown = (signal: string) => {
     logger.info('shutdown', { signal, message: `${signal} received, starting graceful shutdown...` });
     isShuttingDown = true;
     server.close(() => {
       logger.info('shutdown', { message: 'Server closed' });
       process.exit(0);
     });
     setTimeout(() => {
       logger.error('shutdown', { message: 'Forced shutdown after 30 seconds' });
       process.exit(1);
     }, 30000);
   };

   process.on('SIGTERM', () => gracefulShutdown('SIGTERM'));
   process.on('SIGINT', () => gracefulShutdown('SIGINT'));
   ```

3. Replace the existing cors() call — currently uses ALLOWED_ORIGIN (singular, wildcard) — with a callback-based CORS config using ALLOWED_ORIGINS (plural, comma-separated) parsed from env:
   ```typescript
   import { logger } from './services/logger';

   const allowedOrigins = (env.ALLOWED_ORIGINS || '')
     .split(',')
     .map((o) => o.trim())
     .filter(Boolean);

   const corsOptions: CorsOptions = {
     origin: function (origin, callback) {
       if (!origin) return callback(null, true);
       if (allowedOrigins.includes(origin)) {
         callback(null, true);
       } else {
         logger.warn('cors_blocked', { origin });
         callback(new Error(`Origin ${origin} not allowed by CORS`));
       }
     },
     methods: ['GET', 'POST', 'HEAD', 'OPTIONS'],
     credentials: false,
     maxAge: 3600,
   };

   app.use(cors(corsOptions));
   ```
   Import `CorsOptions` from `'cors'`.

4. Add a middleware to reject requests during shutdown (before route handlers):
   ```typescript
   app.use((req, res, next) => {
     if (isShuttingDown) {
       res.status(503).json({ error: 'server_shutting_down', message: 'Server is shutting down' });
       return;
     }
     next();
   });
   ```
   Place this middleware after cors but before express.json.

Use the existing `logger` service (already imported indirectly — import explicitly: `import { logger } from './services/logger';`). Replace the `console.log` in the listen callback with `logger.info('server_start', { port })`.
  </action>
  <verify>
    Run: `cd /Users/brunocampos/Twelvify/backend && npx tsc --noEmit`
    Expected: No TypeScript errors.
  </verify>
  <done>index.ts compiles cleanly; contains process.on('SIGTERM'), allowedOrigins.includes, and server.close().</done>
</task>

<task type="auto">
  <name>Task 2: Upgrade health endpoint to deep check with Anthropic ping, version info, and memory stats</name>
  <files>backend/src/routes/health.ts, backend/src/config/env.ts, backend/src/config/constants.ts, backend/src/middleware/rateLimit.ts</files>
  <action>
**backend/src/routes/health.ts** — Replace the minimal health handler with a deep check:

```typescript
import { Router } from 'express';
import { OpenAI } from 'openai';
import { env } from '../config/env';

export const healthRouter = Router();

healthRouter.get('/health', async (_req, res) => {
  const startTime = Date.now();

  const payload: Record<string, unknown> = {
    status: 'ok',
    timestamp: new Date().toISOString(),
    uptime: Math.round(process.uptime()),
    version: {
      gitSha: process.env.GIT_SHA || 'unknown',
      buildTime: process.env.BUILD_TIMESTAMP || 'unknown',
    },
    memory: {
      heapUsedMb: Math.round(process.memoryUsage().heapUsed / 1024 / 1024),
      heapTotalMb: Math.round(process.memoryUsage().heapTotal / 1024 / 1024),
    },
    checks: {
      anthropic: 'pending',
    },
  };

  try {
    const client = new OpenAI({ apiKey: env.OPENAI_API_KEY });
    await client.models.list();
    (payload.checks as Record<string, string>).anthropic = 'ok';
  } catch (err) {
    (payload.checks as Record<string, string>).anthropic = 'failed';
    payload.status = 'degraded';
    payload.responseTimeMs = Date.now() - startTime;
    res.status(503).json(payload);
    return;
  }

  payload.responseTimeMs = Date.now() - startTime;
  res.status(200).json(payload);
});
```

**backend/src/config/env.ts** — Update the Zod schema to:
- Rename `ALLOWED_ORIGIN` → `ALLOWED_ORIGINS` (plural, comma-separated string, default `''`)
- Add `GIT_SHA` (optional string, default `'unknown'`)
- Add `BUILD_TIMESTAMP` (optional string, default `'unknown'`)
- Keep all other existing fields unchanged

New schema shape (replace existing ALLOWED_ORIGIN line):
```typescript
ALLOWED_ORIGINS: z.string().default(''),
GIT_SHA: z.string().default('unknown'),
BUILD_TIMESTAMP: z.string().default('unknown'),
```

**backend/src/config/constants.ts** — Update RATE_LIMIT:
```typescript
export const RATE_LIMIT = {
  windowMs: 60 * 1000,  // 1 minute window (changed from 1 hour)
  max: 30,              // 30 requests per minute per IP (conservative for API costs)
};
```

**backend/src/middleware/rateLimit.ts** — Add `skip` option to skip rate limiting for `/health` requests:
```typescript
skip: (req) => req.path === '/health',
```
Add this field to the existing rateLimit config object (after the handler property).
  </action>
  <verify>
    Run: `cd /Users/brunocampos/Twelvify/backend && npx tsc --noEmit`
    Expected: No TypeScript errors. Confirm health.ts references openai.models.list() and env.ts exports ALLOWED_ORIGINS.
    Run: `grep -r "ALLOWED_ORIGIN[^S]" /Users/brunocampos/Twelvify/backend/src/` — should return empty (no old singular references remaining).
  </verify>
  <done>health.ts performs Anthropic API call and returns 503 on failure; env.ts exports ALLOWED_ORIGINS; constants.ts shows 30 req/min; rateLimit.ts skips /health.</done>
</task>

</tasks>

<verification>
After both tasks complete:
1. `cd /Users/brunocampos/Twelvify/backend && npx tsc --noEmit` — zero errors
2. `grep "SIGTERM" /Users/brunocampos/Twelvify/backend/src/index.ts` — found
3. `grep "allowedOrigins.includes" /Users/brunocampos/Twelvify/backend/src/index.ts` — found
4. `grep "models.list" /Users/brunocampos/Twelvify/backend/src/routes/health.ts` — found
5. `grep "ALLOWED_ORIGINS" /Users/brunocampos/Twelvify/backend/src/config/env.ts` — found
6. `grep "windowMs: 60 \* 1000" /Users/brunocampos/Twelvify/backend/src/config/constants.ts` — found
</verification>

<success_criteria>
- TypeScript compiles without errors
- SIGTERM handler added to index.ts — server.close() + 30s force-exit
- Shutdown middleware returns 503 during isShuttingDown
- CORS uses allowedOrigins callback (not wildcard)
- env.ts exports ALLOWED_ORIGINS (plural), GIT_SHA, BUILD_TIMESTAMP
- /health pings Anthropic API and returns 503 on failure
- Rate limit reduced to 30/min; /health skipped from rate limiting
</success_criteria>

<output>
After completion, create `.planning/phases/09-backend-production-deploy/09-01-SUMMARY.md`
</output>
