---
phase: 09-backend-production-deploy
plan: 03
type: execute
wave: 2
depends_on: [09-01, 09-02]
files_modified: []
autonomous: false
requirements: [DEPL-01, DEPL-02, DEPL-03, DEPL-04, DEPL-05, DEPL-06]
user_setup:
  - service: render
    why: "Production backend hosting — Express server deployed as a web service"
    env_vars:
      - name: OPENAI_API_KEY
        source: "Your Anthropic/OpenAI API key (same value used in backend/.env.local)"
    dashboard_config:
      - task: "Create a Render account at https://render.com if you don't have one"
        location: "https://render.com/register"
      - task: "Connect your GitHub repository to Render"
        location: "Render Dashboard -> New -> Blueprint (Import from GitHub)"
      - task: "Set OPENAI_API_KEY as a secret environment variable in the Render service dashboard"
        location: "Render Dashboard -> twelvify-backend -> Environment -> Add Secret File or Environment Variable"
      - task: "Trigger first deploy from the Render dashboard (or push to main)"
        location: "Render Dashboard -> twelvify-backend -> Manual Deploy"

must_haves:
  truths:
    - "Backend is live on Render and /health returns 200 with anthropic: 'ok'"
    - "End-to-end simplification works: highlight text on a webpage, click button, streamed result appears"
    - "curl to /health from terminal returns 200 with version, memory, and checks.anthropic: 'ok'"
    - "No localhost references exist in the production extension build output"
  artifacts:
    - path: "render.yaml"
      provides: "Deployed via Render Blueprint — service is live"
    - path: "backend/src/routes/health.ts"
      provides: "Live /health endpoint returns 200 OK with deep checks"
  key_links:
    - from: "Render service"
      to: "https://twelvify-backend.onrender.com/health"
      via: "curl or browser GET"
      pattern: "200 OK"
    - from: "Extension (loaded in Chrome)"
      to: "https://twelvify-backend.onrender.com/api/simplify"
      via: "content.ts fetch() triggered by user highlight + click"
      pattern: "SSE stream returns simplified text"
---

<objective>
Deploy the hardened backend to Render using render.yaml, verify the live deployment is healthy, and confirm end-to-end simplification works from the extension using the production backend.

Purpose: This is the human-gated final step of Phase 9 — the user creates the Render service, sets the OPENAI_API_KEY secret, triggers the first deploy, and verifies the production backend is operational before Phase 10 (Chrome Web Store submission).

Output: Live production backend at https://twelvify-backend.onrender.com verified end-to-end.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-backend-production-deploy/09-01-SUMMARY.md
@.planning/phases/09-backend-production-deploy/09-02-SUMMARY.md
@render.yaml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build extension and verify no localhost in build output</name>
  <files></files>
  <action>
Run the production build for the extension and verify no localhost references appear in the output:

```bash
cd /Users/brunocampos/Twelvify && npm run build 2>&1
```

After build completes, check the dist output:
```bash
grep -r "localhost" /Users/brunocampos/Twelvify/.output/ 2>/dev/null | grep -v ".map"
```

Expected: No matches. If localhost appears in non-map files, investigate which file contains it and fix the source before proceeding.

Also confirm the production URL appears in the build:
```bash
grep -r "onrender.com" /Users/brunocampos/Twelvify/.output/ 2>/dev/null | grep -v ".map" | head -5
```

Expected: At least one reference to onrender.com in the built extension files.
  </action>
  <verify>
    `grep -r "localhost" /Users/brunocampos/Twelvify/.output/ 2>/dev/null | grep -v ".map"` — empty output
    `grep -r "onrender.com" /Users/brunocampos/Twelvify/.output/ 2>/dev/null | grep -v ".map"` — has results
  </verify>
  <done>Extension build output contains no localhost references; production Render URL present in built files.</done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 2: Deploy backend to Render and set OPENAI_API_KEY</name>
  <files></files>
  <action>
Human must create the Render service using render.yaml and set the OPENAI_API_KEY secret.
This step requires browser-based actions in Render's dashboard (no CLI for initial Blueprint creation).

Instructions:
1. Visit https://render.com — sign up or log in
2. Dashboard → "New +" → "Blueprint" → connect GitHub → select Twelvify repo
3. Render detects render.yaml → shows twelvify-backend preview → click "Apply"
4. After service is created: Dashboard → twelvify-backend → Environment → Add Environment Variable
   - Key: OPENAI_API_KEY | Value: (API key from backend/.env.local) | Mark as Secret
5. Click "Save Changes" to trigger redeploy
6. Wait for deploy logs to show "Build successful" and server listening message
7. Confirm the service URL: should be https://twelvify-backend.onrender.com
  </action>
  <verify>Render Dashboard shows twelvify-backend service with status "Live" and latest deploy succeeded.</verify>
  <done>Backend deployed on Render, OPENAI_API_KEY set, service URL confirmed.</done>
  <instructions>
The backend code and render.yaml are ready. Now create the Render service and deploy:

**Step 1: Create Render account (if needed)**
Visit https://render.com and sign up or log in.

**Step 2: Deploy via Blueprint (render.yaml)**
1. In Render Dashboard → click "New +" → "Blueprint"
2. Connect your GitHub account if not already connected
3. Select the Twelvify repository
4. Render will detect render.yaml and show a preview of the twelvify-backend service
5. Click "Apply" to create the service

**Step 3: Set the OPENAI_API_KEY secret**
1. After Blueprint creates the service, go to: Render Dashboard → twelvify-backend → Environment
2. Click "Add Environment Variable"
3. Key: `OPENAI_API_KEY`  Value: (your Anthropic/OpenAI API key from backend/.env.local)
4. Mark it as Secret
5. Click "Save Changes" — this triggers a redeploy

**Step 4: Wait for deploy to complete**
Watch the deploy logs in Render Dashboard → twelvify-backend → Logs. Wait until you see:
- "Build successful"
- "Server listening on port 3001" (or similar)

**Step 5: Confirm the service URL**
The service URL will be shown in the Render dashboard. It should be:
`https://twelvify-backend.onrender.com`

If the URL is different (Render assigns a unique name), note it — you'll need it in the next step.

Type "deployed" when the service is live and showing a successful deploy in the Render dashboard.
  </instructions>
  <resume-signal>Type "deployed" to continue, or "failed [reason]" if deployment failed</resume-signal>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify live backend health and end-to-end simplification</name>
  <files></files>
  <action>
Human verifies the deployed backend is healthy and extension works end-to-end against production.

Automated pre-checks Claude can run:
```bash
curl -s https://twelvify-backend.onrender.com/health | python3 -m json.tool
```
Expected: HTTP 200, status: "ok", checks.anthropic: "ok".
  </action>
  <verify>
    curl https://twelvify-backend.onrender.com/health returns 200 with checks.anthropic: "ok"
    Extension on a real webpage produces simplified text using the production backend
  </verify>
  <done>Health endpoint returns 200 with anthropic: "ok"; extension end-to-end simplification confirmed against production Render URL.</done>
  <what-built>
    Production Express backend on Render with:
    - Deep health check (Anthropic API ping, version info, memory)
    - Graceful SIGTERM shutdown
    - CORS scoped to https://twelvify.com (chrome-extension ID to be added after Web Store approval)
    - Rate limiting: 30 req/min
    - render.yaml for reproducible deploys
  </what-built>
  <how-to-verify>
1. **Health check via curl (terminal):**
   ```bash
   curl -s https://twelvify-backend.onrender.com/health | python3 -m json.tool
   ```
   Expected response:
   ```json
   {
     "status": "ok",
     "timestamp": "...",
     "uptime": ...,
     "version": { "gitSha": "...", "buildTime": "..." },
     "memory": { "heapUsedMb": ..., "heapTotalMb": ... },
     "checks": { "anthropic": "ok" },
     "responseTimeMs": ...
   }
   ```
   Pass criteria: HTTP 200, `status: "ok"`, `checks.anthropic: "ok"`.

2. **End-to-end simplification with extension:**
   a. Open Chrome with the extension loaded (dev mode)
   b. Navigate to any webpage with readable text (e.g., https://en.wikipedia.org/wiki/Wikipedia)
   c. Highlight a sentence of text (10-50 words)
   d. Click the floating wand button that appears
   e. Verify: Simplified text streams in and replaces the selection

3. **Check landing page playground (optional):**
   The landing page uses a dev proxy (`/api` → `localhost:3001`). In production the landing page fetches `/api` relative to itself — this works when both are on the same domain or when the playground is updated for the production URL. This is tracked but not a blocker for Phase 9 completion.

Note: If the Render URL is NOT `twelvify-backend.onrender.com` (Render assigned a different subdomain), update `src/entrypoints/content.ts` and `wxt.config.ts` with the correct URL and rebuild.
  </how-to-verify>
  <resume-signal>Type "verified" if health check returns 200 and simplification works end-to-end. Type "issue [description]" if any check fails.</resume-signal>
</task>

</tasks>

<verification>
Phase 9 complete when:
1. `curl https://twelvify-backend.onrender.com/health` returns 200 with `checks.anthropic: "ok"`
2. Extension end-to-end simplification works against production backend
3. Build output has no localhost references
4. render.yaml committed to main branch
</verification>

<success_criteria>
- Backend live on Render at https://twelvify-backend.onrender.com
- /health returns 200 with anthropic: "ok" (DEPL-01, DEPL-02)
- SIGTERM handler present in deployed code (DEPL-03)
- Extension build contains no localhost, uses production URL (DEPL-04)
- CORS allows twelvify.com; chrome-extension origins tracked for Phase 10 (DEPL-05, DEPL-06)
- End-to-end simplification verified in production
</success_criteria>

<output>
After completion, create `.planning/phases/09-backend-production-deploy/09-03-SUMMARY.md`
</output>
