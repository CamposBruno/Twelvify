---
phase: 09-backend-production-deploy
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - render.yaml
  - src/entrypoints/content.ts
  - wxt.config.ts
autonomous: true
requirements: [DEPL-01, DEPL-04]

must_haves:
  truths:
    - "render.yaml exists in repo root with service name twelvify-backend, health check path /health, and rolling deploy strategy"
    - "Extension content.ts uses the production Render URL for BACKEND_URL (not localhost)"
    - "wxt.config.ts host_permissions contains only the production Render URL (localhost removed)"
    - "render.yaml documents which env vars must be set manually in Render dashboard (OPENAI_API_KEY, GIT_SHA, BUILD_TIMESTAMP)"
  artifacts:
    - path: "render.yaml"
      provides: "Render IaC config: service type=web, runtime=node, build/start commands, health check, env vars"
      contains: "healthCheckPath"
    - path: "src/entrypoints/content.ts"
      provides: "BACKEND_URL points to https://twelvify-backend.onrender.com/api/simplify"
    - path: "wxt.config.ts"
      provides: "host_permissions contains only https://twelvify-backend.onrender.com/*"
  key_links:
    - from: "render.yaml"
      to: "Render platform"
      via: "Auto-deploy on push to main branch with healthCheckPath: /health"
      pattern: "healthCheckPath"
    - from: "src/entrypoints/content.ts"
      to: "https://twelvify-backend.onrender.com"
      via: "BACKEND_URL constant used in fetch call"
      pattern: "onrender\\.com"
---

<objective>
Create render.yaml (Infrastructure as Code for Render) and update the extension to point to the production Render URL. These are independent infrastructure setup tasks that do not touch backend source code.

Purpose: render.yaml makes deployment reproducible and version-controlled. Extension URL update is required before the production build — manifest must not reference localhost when submitted to Chrome Web Store.

Output: render.yaml committed to repo root; extension BACKEND_URL and host_permissions updated to production Render URL.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-backend-production-deploy/09-CONTEXT.md
@.planning/phases/09-backend-production-deploy/09-RESEARCH.md
@wxt.config.ts
@src/entrypoints/content.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create render.yaml in repo root</name>
  <files>render.yaml</files>
  <action>
Create `/Users/brunocampos/Twelvify/render.yaml` with the following content:

```yaml
# render.yaml — Render Blueprint (Infrastructure as Code)
# Docs: https://render.com/docs/blueprint-spec
# Deploy: Push to main branch triggers auto-deploy

services:
  - type: web
    name: twelvify-backend
    runtime: node
    rootDir: backend
    buildCommand: npm install && npm run build
    startCommand: npm start
    envVars:
      - key: NODE_ENV
        value: production
      - key: PORT
        value: "3001"
      - key: ALLOWED_ORIGINS
        # chrome-extension://* allows any extension ID during dev/testing.
        # After Chrome Web Store approval: replace * with the assigned extension ID.
        # Format: comma-separated list of allowed origins
        value: "chrome-extension://,https://twelvify.com"
      - key: LOG_LEVEL
        value: info
      # These vars must be set manually in the Render dashboard (secrets):
      # - OPENAI_API_KEY  : Anthropic/OpenAI API key
      # - GIT_SHA         : Set in Render dashboard or injected by build hook
      # - BUILD_TIMESTAMP : Set in Render dashboard or injected by build hook
    healthCheckPath: /health
    autoDeploy: true
    plan: free
```

Key notes on the config:
- `rootDir: backend` — tells Render to run build/start commands from the backend/ subdirectory (where package.json lives)
- `healthCheckPath: /health` — Render pings this every 30s; non-2xx causes rollback
- `ALLOWED_ORIGINS` value uses `chrome-extension://` (no wildcard suffix — the callback in index.ts checks `.includes(origin)`, so the origin `chrome-extension://[ID]` needs to be present; document in a comment that this needs to be updated with the real extension ID post-Web Store approval). Actually use `chrome-extension://*` is not a valid URL format — instead leave `ALLOWED_ORIGINS` as a placeholder that includes a comment instructing manual update. Set the value to just `https://twelvify.com` for now with a clear comment. The chrome-extension origin will be added after the extension ID is known (Phase 10 follow-up).

Revised ALLOWED_ORIGINS value:
```
value: "https://twelvify.com"
# NOTE: After Chrome Web Store submission, add the extension ID:
# value: "chrome-extension://YOUR_EXTENSION_ID_HERE,https://twelvify.com"
```

Use inline YAML comment for the note. The comma-separated format matches the env.ts parser.
  </action>
  <verify>
    Check file exists: `ls /Users/brunocampos/Twelvify/render.yaml`
    Check key fields: `grep "healthCheckPath\|twelvify-backend\|rootDir" /Users/brunocampos/Twelvify/render.yaml`
    Expected: All three strings found.
  </verify>
  <done>render.yaml exists in repo root with twelvify-backend service, rootDir: backend, healthCheckPath: /health, autoDeploy: true, and ALLOWED_ORIGINS set to https://twelvify.com with comment about adding extension ID post-approval.</done>
</task>

<task type="auto">
  <name>Task 2: Update extension BACKEND_URL and host_permissions to production Render URL</name>
  <files>src/entrypoints/content.ts, wxt.config.ts</files>
  <action>
**src/entrypoints/content.ts** — Update BACKEND_URL constant:

Change line:
```typescript
const BACKEND_URL = 'http://localhost:3001/api/simplify';
```
To:
```typescript
const BACKEND_URL = 'https://twelvify-backend.onrender.com/api/simplify';
```

Remove the `// TODO: Update to production URL before Chrome Web Store submission` comment on the line above (if present).

**wxt.config.ts** — Update host_permissions to remove localhost and keep only the production Render URL:

Change:
```typescript
host_permissions: [
  'https://twelvify-backend.onrender.com/*',
  'http://localhost:3001/*'
],
```
To:
```typescript
host_permissions: [
  'https://twelvify-backend.onrender.com/*',
],
```

Also update the comment above host_permissions to remove the note about "Current URL points to the Render.com deployment used for development/testing" — this is now the production URL, not a dev/testing URL. Replace with: `// Production backend URL on Render. Update ALLOWED_ORIGINS on Render dashboard after Web Store approval.`

Do NOT touch any other wxt.config.ts content (manifest name, permissions, CSP, commands).
  </action>
  <verify>
    `grep "BACKEND_URL" /Users/brunocampos/Twelvify/src/entrypoints/content.ts` — should show onrender.com, not localhost
    `grep "localhost" /Users/brunocampos/Twelvify/wxt.config.ts` — should return empty (no localhost references)
    `grep "localhost" /Users/brunocampos/Twelvify/src/entrypoints/content.ts` — should return empty
  </verify>
  <done>content.ts BACKEND_URL points to https://twelvify-backend.onrender.com/api/simplify; wxt.config.ts host_permissions contains only the production URL with localhost removed.</done>
</task>

</tasks>

<verification>
After both tasks complete:
1. `cat /Users/brunocampos/Twelvify/render.yaml` — shows twelvify-backend service with rootDir, healthCheckPath, ALLOWED_ORIGINS
2. `grep "localhost" /Users/brunocampos/Twelvify/src/entrypoints/content.ts` — empty
3. `grep "localhost" /Users/brunocampos/Twelvify/wxt.config.ts` — empty
4. `grep "onrender.com" /Users/brunocampos/Twelvify/src/entrypoints/content.ts` — found
5. `grep "onrender.com" /Users/brunocampos/Twelvify/wxt.config.ts` — found
</verification>

<success_criteria>
- render.yaml in repo root with valid Render Blueprint format
- Service name: twelvify-backend, rootDir: backend, healthCheckPath: /health
- Extension content.ts uses production Render URL (no localhost)
- wxt.config.ts host_permissions has only the production URL (no localhost)
</success_criteria>

<output>
After completion, create `.planning/phases/09-backend-production-deploy/09-02-SUMMARY.md`
</output>
